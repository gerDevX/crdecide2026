---
import type { Candidate, CandidateScore, DetailedAnalysis } from '../../../lib/types';

interface Props {
  candidates: Array<{
    candidate: Candidate;
    score: CandidateScore;
    analysis?: DetailedAnalysis;
    rank: number;
  }>;
  currentPage?: number;
  itemsPerPage?: number;
}

const { 
  candidates, 
  currentPage = 1, 
  itemsPerPage = 5 
} = Astro.props;

const totalPages = Math.ceil(candidates.length / itemsPerPage);

// Pillar names mapping
const PILLAR_NAMES: Record<string, string> = {
  'P1': 'Responsabilidad Fiscal',
  'P2': 'Empleo e Inversi√≥n',
  'P3': 'Seguridad Ciudadana',
  'P4': 'Salud y CCSS',
  'P5': 'Educaci√≥n',
  'P6': 'Ambiente y Sostenibilidad',
  'P7': 'Reforma del Estado',
  'P8': 'Pobreza y Vulnerabilidad',
  'P9': 'Pol√≠tica Exterior',
  'P10': 'Infraestructura',
};

// Helper function to get candidate display name
function getCandidateName(candidate: Candidate): string {
  const name = candidate.candidate_name;
  if (name && name !== 'Por determinar' && name !== 'no_especificado') {
    return name;
  }
  return candidate.party_name;
}

// Helper function to get risk level color
function getRiskColor(riskLevel: string): string {
  switch (riskLevel) {
    case 'BAJO': return '#22c55e';
    case 'MEDIO': return '#f59e0b';
    case 'ALTO': return '#ef4444';
    default: return '#22c55e';
  }
}
---

<article class="reading-container">
  <header class="mb-8">
    <h1 class="reading-title">Ranking de Candidatos</h1>
    <p class="reading-body">
      Estos son los {candidates.length} candidatos presidenciales ordenados 
      seg√∫n su puntaje ponderado, basado en el an√°lisis de sus planes de gobierno.
    </p>
  </header>

  <!-- Buscador de candidatos -->
  <div class="reading-search-container">
    <label for="reading-candidate-search" class="reading-search-label">
      üîç Buscar candidato:
    </label>
    <select id="reading-candidate-search" class="reading-search-select">
      <option value="">-- Seleccione un candidato --</option>
      {candidates.map(({ candidate, rank }) => {
        const candidateName = getCandidateName(candidate);
        return (
          <option value={candidate.candidate_id}>
            #{rank} - {candidateName} ({candidate.party_name})
          </option>
        );
      })}
    </select>
    
    <div class="reading-quick-filters">
      <button type="button" class="reading-filter-btn" data-filter="all">
        Todos
      </button>
      <button type="button" class="reading-filter-btn" data-filter="top5">
        Top 5
      </button>
      <button type="button" class="reading-filter-btn" data-filter="top10">
        Top 10
      </button>
    </div>
  </div>

  <div class="reading-divider"></div>

  <!-- All candidates, controlled by JS pagination -->
  <section id="reading-candidates-list">
    {candidates.map(({ candidate, score, analysis, rank }) => {
      const percentage = Math.round(score.overall.weighted_sum * 100);
      const candidateName = getCandidateName(candidate);
      const riskLevel = analysis?.risk_level || 'BAJO';
      const riskColor = getRiskColor(riskLevel);
      
      return (
        <article class="reading-candidate-item" data-rank={rank}>
        <div class="reading-rank">
          {rank}.
        </div>
        <div class="reading-candidate-content">
          <h2 class="reading-subtitle">
              {candidateName}
            </h2>
            {candidate.candidate_name && candidate.candidate_name !== 'Por determinar' && candidate.candidate_name !== 'no_especificado' && (
              <p class="reading-party-name">
            {candidate.party_name}
            </p>
          )}
            
          <div class="reading-score-box">
              <div class="reading-score-header">
            <div class="reading-score-value">
                  <span class="reading-percentage">{percentage}%</span>
                  <span class="reading-score-label">Puntaje General</span>
                </div>
                <div class="reading-risk-badge" style={`background-color: ${riskColor}20; color: ${riskColor}; border-color: ${riskColor}`}>
                  Riesgo {riskLevel.toLowerCase()}
                </div>
            </div>
            <div class="reading-score-bar">
              <div 
                class="reading-score-fill" 
                  style={`width: ${percentage}%; background-color: ${riskColor}`}
              ></div>
            </div>
          </div>
            
            <div class="reading-pillars">
              <strong>Puntaje por Pilar:</strong>
              <p class="reading-pillars-legend">
                El porcentaje indica qu√© tan completa es la propuesta del candidato en cada √°rea 
                (100% = propuesta con existencia, plazo, mecanismo y financiamiento definidos).
              </p>
              <div class="reading-pillars-list">
                {score.pillar_scores.map((pillar) => {
                  const pillarPercent = Math.round((pillar.effective_score / 4) * 100);
                  const pillarName = PILLAR_NAMES[pillar.pillar_id] || pillar.pillar_id;
                  return (
                    <div class="reading-pillar-row">
                      <span class="reading-pillar-name">
                        <span class="reading-pillar-id-badge">{pillar.pillar_id}</span>
                        {pillarName}
                      </span>
                      <span class="reading-pillar-score" style={`color: ${pillarPercent >= 75 ? '#22c55e' : pillarPercent >= 50 ? '#f59e0b' : '#ef4444'}`}>
                        {pillarPercent}%
                      </span>
                    </div>
                  );
                })}
              </div>
          </div>
            
          <a 
            href={`/candidatos/${candidate.candidate_id}`}
            class="reading-link"
          >
            Ver propuestas completas ‚Üí
          </a>
        </div>
      </article>
      );
    })}
  </section>

  <div class="reading-divider"></div>

  <!-- Pagination -->
  <nav class="reading-nav" aria-label="Paginaci√≥n">
    <button id="reading-prev-btn" class="reading-nav-btn" disabled>
        ‚Üê Anterior
    </button>
    
    <span id="reading-page-info" class="text-slate-600">
      P√°gina 1 de {totalPages}
    </span>
    
    <button id="reading-next-btn" class="reading-nav-btn">
        Siguiente ‚Üí
    </button>
  </nav>

  <div class="reading-divider"></div>

  <footer class="text-center">
    <a href="/metodologia" class="reading-link">
      ¬øC√≥mo se calcula el puntaje? ‚Üí
    </a>
  </footer>
</article>

<script define:vars={{ itemsPerPage, totalPages }}>
  document.addEventListener('DOMContentLoaded', () => {
    let currentPage = 1;
    let currentFilter = 'all';
    let filteredItems = [];
    
    const allItems = document.querySelectorAll('.reading-candidate-item');
    const prevBtn = document.getElementById('reading-prev-btn');
    const nextBtn = document.getElementById('reading-next-btn');
    const pageInfo = document.getElementById('reading-page-info');
    const searchSelect = document.getElementById('reading-candidate-search');
    const filterBtns = document.querySelectorAll('.reading-filter-btn');
    
    function getFilteredItems() {
      let items = Array.from(allItems);
      
      if (currentFilter === 'top5') {
        items = items.filter((item) => {
          const rank = parseInt(item.getAttribute('data-rank') || '0');
          return rank <= 5;
        });
      } else if (currentFilter === 'top10') {
        items = items.filter((item) => {
          const rank = parseInt(item.getAttribute('data-rank') || '0');
          return rank <= 10;
        });
      }
      
      return items;
    }
    
    function updatePagination() {
      filteredItems = getFilteredItems();
      const totalFilteredPages = Math.ceil(filteredItems.length / itemsPerPage);
      
      // Ensure currentPage is valid
      if (currentPage > totalFilteredPages) {
        currentPage = 1;
      }
      
      // Hide all items first
      allItems.forEach((item) => {
        item.style.display = 'none';
      });
      
      // Show filtered items for current page
      const startIndex = (currentPage - 1) * itemsPerPage;
      const endIndex = startIndex + itemsPerPage;
      
      filteredItems.forEach((item, index) => {
        if (index >= startIndex && index < endIndex) {
          item.style.display = 'flex';
        }
      });
      
      // Update page info
      pageInfo.textContent = `P√°gina ${currentPage} de ${totalFilteredPages} (${filteredItems.length} candidatos)`;
      
      // Update button states
      prevBtn.disabled = currentPage <= 1;
      nextBtn.disabled = currentPage >= totalFilteredPages;
      
      // Update button styles
      prevBtn.style.opacity = currentPage <= 1 ? '0.5' : '1';
      prevBtn.style.cursor = currentPage <= 1 ? 'not-allowed' : 'pointer';
      nextBtn.style.opacity = currentPage >= totalFilteredPages ? '0.5' : '1';
      nextBtn.style.cursor = currentPage >= totalFilteredPages ? 'not-allowed' : 'pointer';
    }
    
    function scrollToCandidate(candidateId) {
      if (!candidateId) {
        currentPage = 1;
        updatePagination();
        return;
      }
      
      // Find the candidate item
      const candidateItem = document.querySelector(`.reading-candidate-item a[href="/candidatos/${candidateId}"]`)?.closest('.reading-candidate-item');
      
      if (candidateItem) {
        // Reset filter to show all
        currentFilter = 'all';
        updateFilterButtons();
        
        // Find the index of this item
        const allItemsArray = Array.from(allItems);
        const itemIndex = allItemsArray.indexOf(candidateItem);
        
        // Calculate which page this item is on
        currentPage = Math.floor(itemIndex / itemsPerPage) + 1;
        updatePagination();
        
        // Scroll to the item
        setTimeout(() => {
          candidateItem.scrollIntoView({ behavior: 'smooth', block: 'center' });
          // Highlight the item briefly
          candidateItem.style.backgroundColor = '#fef3c7';
          setTimeout(() => {
            candidateItem.style.backgroundColor = '';
          }, 2000);
        }, 100);
      }
    }
    
    function updateFilterButtons() {
      filterBtns.forEach((btn) => {
        const filter = btn.getAttribute('data-filter');
        if (filter === currentFilter) {
          btn.classList.add('active');
        } else {
          btn.classList.remove('active');
        }
      });
    }
    
    // Event listeners
    prevBtn?.addEventListener('click', () => {
      if (currentPage > 1) {
        currentPage--;
        updatePagination();
        document.getElementById('reading-candidates-list')?.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }
    });
    
    nextBtn?.addEventListener('click', () => {
      const totalFilteredPages = Math.ceil(filteredItems.length / itemsPerPage);
      if (currentPage < totalFilteredPages) {
        currentPage++;
        updatePagination();
        document.getElementById('reading-candidates-list')?.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }
    });
    
    searchSelect?.addEventListener('change', (e) => {
      scrollToCandidate(e.target.value);
    });
    
    filterBtns.forEach((btn) => {
      btn.addEventListener('click', () => {
        currentFilter = btn.getAttribute('data-filter') || 'all';
        currentPage = 1;
        updateFilterButtons();
        updatePagination();
        document.getElementById('reading-candidates-list')?.scrollIntoView({ behavior: 'smooth', block: 'start' });
      });
    });
    
    // Initial update
    updateFilterButtons();
    updatePagination();
  });
</script>

<style>
  /* ===========================================
     MODO LECTURA - Optimizado para adultos mayores
     - Fuentes grandes (base 20px)
     - Alto contraste
     - Interlineado generoso
     - Espaciado amplio
     =========================================== */
  
  .reading-container {
    max-width: 48rem;
    margin: 0 auto;
    padding: 3rem 2rem;
    font-size: 1.25rem; /* 20px base */
    line-height: 1.8;
  }
  
  .reading-title {
    font-size: 2.5rem; /* 40px */
    font-weight: bold;
    color: #1e293b; /* Mayor contraste */
    margin-bottom: 1.5rem;
    font-family: Georgia, 'Times New Roman', serif;
    line-height: 1.3;
  }
  
  /* ===========================================
     BUSCADOR DE CANDIDATOS
     =========================================== */
  
  .reading-search-container {
    background: #f8fafc;
    border: 2px solid #e2e8f0;
    border-radius: 1rem;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
  }
  
  .reading-search-label {
    display: block;
    font-size: 1.25rem;
    font-weight: 700;
    color: #1e293b;
    margin-bottom: 0.75rem;
    font-family: Georgia, 'Times New Roman', serif;
  }
  
  .reading-search-select {
    width: 100%;
    padding: 1rem 1.25rem;
    font-size: 1.25rem;
    font-family: Georgia, 'Times New Roman', serif;
    border: 3px solid #94a3b8;
    border-radius: 0.75rem;
    background: white;
    color: #1e293b;
    cursor: pointer;
    appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%2364748b' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 1rem center;
    padding-right: 3rem;
  }
  
  .reading-search-select:focus {
    border-color: #1d4ed8;
    outline: 4px solid rgba(29, 78, 216, 0.2);
  }
  
  .reading-quick-filters {
    display: flex;
    gap: 0.75rem;
    margin-top: 1rem;
    flex-wrap: wrap;
  }
  
  .reading-filter-btn {
    padding: 0.75rem 1.5rem;
    font-size: 1.125rem;
    font-weight: 600;
    font-family: Georgia, 'Times New Roman', serif;
    border: 3px solid #cbd5e1;
    border-radius: 0.75rem;
    background: white;
    color: #475569;
    cursor: pointer;
  }
  
  .reading-filter-btn:hover {
    background: #f1f5f9;
    border-color: #94a3b8;
  }
  
  .reading-filter-btn.active {
    background: #1d4ed8;
    color: white;
    border-color: #1d4ed8;
  }
  
  .reading-subtitle {
    font-size: 1.75rem; /* 28px */
    font-weight: bold;
    color: #1e293b;
    margin-bottom: 0.5rem;
    font-family: Georgia, 'Times New Roman', serif;
    line-height: 1.4;
  }
  
  .reading-party-name {
    color: #475569; /* Mayor contraste que antes */
    font-size: 1.25rem; /* 20px */
    margin-bottom: 1rem;
    font-style: italic;
    font-family: Georgia, 'Times New Roman', serif;
  }
  
  .reading-body {
    font-size: 1.25rem; /* 20px */
    line-height: 1.9;
    color: #334155;
    font-family: Georgia, 'Times New Roman', serif;
  }
  
  .reading-divider {
    border-top: 2px solid #94a3b8; /* M√°s visible */
    margin: 2.5rem 0;
  }
  
  .reading-candidate-item {
    display: flex;
    gap: 1.5rem;
    margin-bottom: 2.5rem;
    padding-bottom: 2.5rem;
    border-bottom: 2px solid #cbd5e1;
  }
  
  .reading-rank {
    font-size: 3rem; /* 48px - muy visible */
    font-weight: bold;
    color: #94a3b8;
    font-family: Georgia, 'Times New Roman', serif;
    min-width: 4rem;
    line-height: 1;
  }
  
  .reading-candidate-content {
    flex: 1;
  }
  
  .reading-score-box {
    background: #f8fafc;
    border: 2px solid #e2e8f0;
    border-radius: 1rem;
    padding: 1.5rem;
    margin: 1.5rem 0;
  }
  
  .reading-score-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
    flex-wrap: wrap;
    gap: 1rem;
  }
  
  .reading-score-value {
    display: flex;
    align-items: baseline;
    gap: 0.75rem;
  }
  
  .reading-percentage {
    font-size: 3rem; /* 48px - muy grande */
    font-weight: bold;
    color: #0f172a;
    line-height: 1;
  }
  
  .reading-score-label {
    font-size: 1.125rem; /* 18px */
    color: #475569;
    font-weight: 500;
  }
  
  .reading-risk-badge {
    padding: 0.5rem 1rem;
    border-radius: 9999px;
    font-size: 1rem; /* 16px */
    font-weight: 700;
    text-transform: capitalize;
    border: 2px solid;
  }
  
  .reading-score-bar {
    height: 1rem; /* M√°s gruesa */
    background: #cbd5e1;
    border-radius: 9999px;
    overflow: hidden;
  }
  
  .reading-score-fill {
    height: 100%;
    border-radius: 9999px;
    transition: width 0.5s ease;
  }
  
  .reading-pillars {
    color: #334155;
    margin: 1.5rem 0;
    font-family: Georgia, 'Times New Roman', serif;
    font-size: 1.25rem;
  }
  
  .reading-pillars strong {
    font-size: 1.375rem; /* 22px */
    color: #1e293b;
  }
  
  .reading-pillars-legend {
    font-size: 1.125rem; /* 18px */
    color: #475569;
    font-style: italic;
    margin: 0.75rem 0 1rem 0;
    line-height: 1.7;
    padding: 1rem;
    background: #fef3c7; /* Fondo amarillo suave para destacar */
    border-left: 4px solid #f59e0b;
    border-radius: 0.5rem;
  }
  
  .reading-pillars-list {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
    margin-top: 1rem;
  }
  
  .reading-pillar-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.875rem 1rem;
    background: white;
    border-radius: 0.75rem;
    border: 2px solid #e2e8f0;
  }
  
  .reading-pillar-name {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    font-size: 1.125rem; /* 18px */
    color: #1e293b;
    font-weight: 500;
  }
  
  .reading-pillar-id-badge {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    min-width: 2.5rem;
    padding: 0.25rem 0.5rem;
    font-size: 0.875rem; /* 14px */
    font-weight: 700;
    color: #475569;
    background: #e2e8f0;
    border-radius: 0.375rem;
  }
  
  .reading-pillar-score {
    font-size: 1.375rem; /* 22px */
    font-weight: bold;
    min-width: 4rem;
    text-align: right;
  }
  
  .reading-link {
    color: #1d4ed8;
    text-decoration: underline;
    text-underline-offset: 4px;
    text-decoration-thickness: 2px;
    font-weight: 600;
    font-size: 1.25rem; /* 20px */
    display: inline-block;
    margin-top: 1rem;
    padding: 0.5rem 0;
  }
  
  .reading-link:hover {
    color: #1e40af;
    text-decoration-thickness: 3px;
  }
  
  .reading-nav {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 2rem 0;
    gap: 1.5rem;
  }
  
  #reading-page-info {
    font-size: 1.25rem; /* 20px */
    font-weight: 600;
    color: #1e293b;
  }
  
  .reading-nav-btn {
    padding: 1.25rem 2rem;
    background: white;
    border: 3px solid #94a3b8;
    border-radius: 0.75rem;
    font-size: 1.25rem; /* 20px */
    font-weight: 600;
    color: #1e293b;
    min-width: 160px;
    text-align: center;
    text-decoration: none;
    cursor: pointer;
    transition: all 0.2s;
    font-family: Georgia, 'Times New Roman', serif;
  }
  
  .reading-nav-btn:hover:not(:disabled) {
    background: #f1f5f9;
    border-color: #64748b;
    transform: translateY(-2px);
  }
  
  .reading-nav-btn:disabled {
    opacity: 0.4;
    cursor: not-allowed;
  }

  /* ===========================================
     RESPONSIVE - Mantener legibilidad en m√≥vil
     =========================================== */
  @media (max-width: 640px) {
    .reading-container {
      padding: 2rem 1.25rem;
      font-size: 1.125rem; /* 18px en m√≥vil */
    }
    
    .reading-title {
      font-size: 2rem; /* 32px */
    }
    
    .reading-subtitle {
      font-size: 1.5rem; /* 24px */
    }
    
    .reading-rank {
      font-size: 2.5rem;
      min-width: 3rem;
    }
    
    .reading-percentage {
      font-size: 2.5rem;
    }
    
    .reading-candidate-item {
      gap: 1rem;
    }
    
    .reading-pillar-row {
      padding: 0.75rem;
    }
    
    .reading-pillar-name {
      font-size: 1rem;
      gap: 0.5rem;
    }
    
    .reading-pillar-id-badge {
      font-size: 0.75rem;
      min-width: 2rem;
      padding: 0.125rem 0.375rem;
    }
    
    .reading-pillar-score {
      font-size: 1.125rem;
      min-width: 3rem;
    }
    
    .reading-nav {
      flex-direction: column;
      gap: 1rem;
    }
    
    .reading-nav-btn {
      min-width: 100%;
      padding: 1rem 1.5rem;
      font-size: 1.125rem;
    }
    
    .reading-search-container {
      padding: 1.25rem;
    }
    
    .reading-search-label {
      font-size: 1.125rem;
    }
    
    .reading-search-select {
      font-size: 1rem;
      padding: 0.875rem 1rem;
    }
    
    .reading-quick-filters {
      justify-content: center;
    }
    
    .reading-filter-btn {
      flex: 1;
      text-align: center;
      padding: 0.625rem 1rem;
      font-size: 1rem;
    }
    
    .reading-score-header {
      flex-direction: column;
      align-items: flex-start;
    }
  }
</style>
