---
import type { Candidate, CandidateScore, PillarScore } from '../../../lib/types';
import { pillarIndex } from '../../../lib/data';
import ScoreBar from '../../ui/ScoreBar.astro';

interface Props {
  candidate: Candidate;
  score: CandidateScore;
  rank: number;
  totalCandidates: number;
}

const { candidate, score, rank, totalCandidates } = Astro.props;

// Get top 6 pillar scores
const topPillars = score.pillar_scores
  .slice(0, 6)
  .map(ps => ({
    ...ps,
    pillar: pillarIndex[ps.pillar_id],
  }));
---

<div class="express-card-wrapper">
  <div class="card-express glass-card-enhanced">
    <!-- Animated Border -->
    <div class="card-border-beam"></div>
    
    <!-- Rank Badge with Shine -->
    <div class="absolute top-4 right-4">
      <span class="express-rank-badge badge-shine">
        <span class="rank-icon">üèÜ</span>
        #{rank}
      </span>
    </div>

    <!-- Fiscal Risk Indicator -->
    {score.overall.fiscal_risk_level && (
      <div class="absolute top-4 left-4">
        <span class={`fiscal-badge ${score.overall.fiscal_risk_level === 'BAJO' ? 'fiscal-low' : score.overall.fiscal_risk_level === 'MEDIO' ? 'fiscal-medium' : 'fiscal-high'}`}>
          {score.overall.fiscal_risk_level === 'BAJO' ? 'üü¢' : score.overall.fiscal_risk_level === 'MEDIO' ? 'üü†' : 'üî¥'}
        </span>
      </div>
    )}

    <!-- Party Name with Animation -->
    <div class="text-center mb-6">
      <div class="party-emoji-container">
        <div class="emoji-glow"></div>
        <div class="text-5xl party-emoji">üó≥Ô∏è</div>
      </div>
      <h2 class="text-2xl font-bold text-slate-900 mb-1 party-name">
        {candidate.party_name}
      </h2>
      <p class="text-slate-500 text-sm candidate-name">
        {candidate.candidate_name !== 'Por determinar' ? candidate.candidate_name : ''}
      </p>
    </div>

    <!-- Score with Animated Ring -->
    <div class="text-center mb-8 score-container">
      <div class="score-ring-wrapper">
         <svg class="score-ring" viewBox="0 0 120 120">
           <defs>
             <linearGradient id="score-gradient" x1="0%" y1="0%" x2="100%" y2="100%">
               <stop offset="0%" style="stop-color:#002b7f" />
               <stop offset="100%" style="stop-color:#1d4ed8" />
             </linearGradient>
           </defs>
          <circle class="score-ring-bg" cx="60" cy="60" r="50" />
          <circle 
            class="score-ring-value" 
            cx="60" 
            cy="60" 
            r="50"
            stroke-dasharray={`${score.overall.weighted_sum * 314} 314`}
          />
        </svg>
        <div class="score-value-inner">
          <div class="express-score-value">
            {Math.round(score.overall.weighted_sum * 100)}%
          </div>
          <p class="text-slate-500 text-xs">Puntaje</p>
        </div>
      </div>
    </div>

    <!-- Score Bar -->
    <div class="mb-8">
      <ScoreBar 
        score={Math.round(score.overall.weighted_sum * 4)} 
        max={4} 
        size="lg" 
        showLabel={true}
      />
    </div>

    <!-- Pillar Grid -->
    <div class="grid grid-cols-3 gap-3 mb-8">
      {topPillars.map(({ pillar_id, effective_score, pillar }) => (
        <div class={`p-3 rounded-xl bg-slate-50 text-center pillar-${pillar_id}`}>
          <div class="text-xs text-slate-500 mb-1">{pillar_id}</div>
          <div class="text-lg font-bold text-slate-900">
            {effective_score}/4
          </div>
          <div class="flex justify-center gap-0.5 mt-1">
            {[1,2,3,4].map(i => (
              <span class={`w-2 h-2 rounded-full ${i <= effective_score ? 'bg-emerald-500' : 'bg-slate-200'}`}></span>
            ))}
          </div>
        </div>
      ))}
    </div>

    <!-- CTA Buttons -->
    <div class="flex gap-3">
      <a 
        href={`/candidatos/${candidate.candidate_id}`} 
        class="flex-1 btn btn-secondary text-center"
      >
        Ver propuestas
      </a>
      <a 
        href={`/comparar?c=${candidate.candidate_id}`} 
        class="flex-1 btn btn-primary text-center"
      >
        Comparar
      </a>
    </div>
  </div>

  <!-- Swipe Hint -->
  <div class="swipe-hint">
    <span>‚Üê Desliza para ver m√°s ‚Üí</span>
  </div>

  <!-- Navigation Dots -->
  <div class="express-dots">
    {Array.from({ length: Math.min(totalCandidates, 10) }).map((_, i) => (
      <span class={`express-dot ${i === rank - 1 ? 'active' : ''}`}></span>
    ))}
    {totalCandidates > 10 && (
      <span class="text-white/50 text-xs ml-2">+{totalCandidates - 10}</span>
    )}
  </div>
</div>

<style>
  .express-card-wrapper {
    min-height: calc(100vh - 80px);
    min-height: calc(100dvh - 80px);
    display: flex;
    flex-direction: column;
    justify-content: center;
    padding: 1.5rem 1rem;
  }
  
  /* Glassmorphism Card */
  .glass-card-enhanced {
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(20px) saturate(180%);
    -webkit-backdrop-filter: blur(20px) saturate(180%);
    border: 1px solid rgba(255, 255, 255, 0.5);
  }
  
  .card-express {
    border-radius: 1.75rem;
    box-shadow: 
      0 25px 50px -12px rgba(0, 0, 0, 0.25),
      0 0 0 1px rgba(255, 255, 255, 0.5) inset;
    padding: 1.75rem;
    position: relative;
    overflow: hidden;
    animation: cardEnter 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
  }
  
  /* Animated Border Beam */
  .card-border-beam {
    position: absolute;
    inset: 0;
    border-radius: inherit;
    padding: 2px;
    background: conic-gradient(
      from 0deg,
      transparent 0deg 80deg,
      #002b7f 80deg 100deg,
      transparent 100deg 180deg,
      #1d4ed8 180deg 200deg,
      transparent 200deg 280deg,
      #ce1126 280deg 300deg,
      transparent 300deg 360deg
    );
    -webkit-mask: 
      linear-gradient(#fff 0 0) content-box, 
      linear-gradient(#fff 0 0);
    mask: 
      linear-gradient(#fff 0 0) content-box, 
      linear-gradient(#fff 0 0);
    -webkit-mask-composite: xor;
    mask-composite: exclude;
    animation: border-beam-spin 6s linear infinite;
    pointer-events: none;
  }
  
  @keyframes border-beam-spin {
    to { transform: rotate(360deg); }
  }
  
  /* Rank Badge with Shine Effect */
  .express-rank-badge {
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
    padding: 0.35rem 0.85rem;
    border-radius: 9999px;
    background: linear-gradient(135deg, #ce1126, #ef4444);
    color: white;
    font-weight: bold;
    font-size: 0.875rem;
    box-shadow: 0 10px 20px -5px rgba(206, 17, 38, 0.4);
    position: relative;
    overflow: hidden;
  }
  
  .badge-shine::after {
    content: '';
    position: absolute;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: linear-gradient(
      to right,
      transparent 0%,
      rgba(255, 255, 255, 0.4) 50%,
      transparent 100%
    );
    transform: rotate(45deg) translateX(-100%);
    animation: badge-shine 3s infinite;
  }
  
  @keyframes badge-shine {
    0% { transform: rotate(45deg) translateX(-100%); }
    100% { transform: rotate(45deg) translateX(100%); }
  }
  
  .rank-icon {
    font-size: 0.75rem;
  }
  
  /* Fiscal Badge */
  .fiscal-badge {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 32px;
    height: 32px;
    border-radius: 50%;
    font-size: 1rem;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
  }
  
  .fiscal-low { background: rgba(34, 197, 94, 0.2); }
  .fiscal-medium { background: rgba(245, 158, 11, 0.2); }
  .fiscal-high { background: rgba(239, 68, 68, 0.2); }
  
  /* Party Emoji with Glow */
  .party-emoji-container {
    position: relative;
    display: inline-block;
    margin-bottom: 1rem;
  }
  
  .emoji-glow {
    position: absolute;
    inset: -20px;
    background: radial-gradient(circle, rgba(0, 43, 127, 0.25) 0%, transparent 70%);
    animation: emoji-pulse 2s ease-in-out infinite;
  }
  
  @keyframes emoji-pulse {
    0%, 100% { opacity: 0.5; transform: scale(1); }
    50% { opacity: 0.8; transform: scale(1.1); }
  }
  
  .party-emoji {
    position: relative;
    z-index: 1;
    animation: emoji-bounce 2s ease-in-out infinite;
  }
  
  @keyframes emoji-bounce {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-5px); }
  }
  
  .party-name {
    animation: fadeInUp 0.5s ease-out 0.2s backwards;
  }
  
  .candidate-name {
    animation: fadeInUp 0.5s ease-out 0.3s backwards;
  }
  
  /* Score Ring */
  .score-container {
    animation: fadeInUp 0.5s ease-out 0.4s backwards;
  }
  
  .score-ring-wrapper {
    position: relative;
    display: inline-flex;
    align-items: center;
    justify-content: center;
  }
  
  .score-ring {
    width: 120px;
    height: 120px;
  }
  
  .score-ring-bg {
    fill: none;
    stroke: #e2e8f0;
    stroke-width: 8;
  }
  
  .score-ring-value {
    fill: none;
    stroke: url(#score-gradient);
    stroke-width: 8;
    stroke-linecap: round;
    transform: rotate(-90deg);
    transform-origin: center;
    animation: ring-fill 1s ease-out 0.5s backwards;
  }
  
  @keyframes ring-fill {
    from { stroke-dasharray: 0 314; }
  }
  
  .score-value-inner {
    position: absolute;
    inset: 0;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
  }
  
  .express-score-value {
    font-size: 1.75rem;
    font-weight: bold;
    background: linear-gradient(135deg, #002b7f, #1d4ed8);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    animation: score-pop 0.5s ease-out 0.8s backwards;
  }
  
  @keyframes score-pop {
    from { transform: scale(0.5); opacity: 0; }
    to { transform: scale(1); opacity: 1; }
  }
  
  .swipe-hint {
    text-align: center;
    color: rgba(255, 255, 255, 0.8);
    font-size: 0.875rem;
    margin-top: 1.5rem;
    animation: swipe-hint-pulse 2s ease-in-out infinite;
  }
  
  @keyframes swipe-hint-pulse {
    0%, 100% { opacity: 0.6; }
    50% { opacity: 1; }
  }
  
  .express-dots {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 0.5rem;
    margin-top: 1rem;
  }
  
  .express-dot {
    width: 0.5rem;
    height: 0.5rem;
    border-radius: 9999px;
    background: rgba(255, 255, 255, 0.3);
    transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
  }
  
  .express-dot.active {
    width: 1.75rem;
    background: white;
    box-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
  }
  
  /* Pillar Grid with Animation */
  .grid > div {
    animation: pillar-enter 0.4s ease-out backwards;
  }
  
  .grid > div:nth-child(1) { animation-delay: 0.5s; }
  .grid > div:nth-child(2) { animation-delay: 0.55s; }
  .grid > div:nth-child(3) { animation-delay: 0.6s; }
  .grid > div:nth-child(4) { animation-delay: 0.65s; }
  .grid > div:nth-child(5) { animation-delay: 0.7s; }
  .grid > div:nth-child(6) { animation-delay: 0.75s; }
  
  @keyframes pillar-enter {
    from { opacity: 0; transform: translateY(10px) scale(0.9); }
    to { opacity: 1; transform: translateY(0) scale(1); }
  }
  
  /* Pillar colors with gradient */
  .pillar-P1 { border-left: 4px solid #10b981; background: linear-gradient(135deg, rgba(16, 185, 129, 0.05), rgba(255, 255, 255, 1)); }
  .pillar-P2 { border-left: 4px solid #3b82f6; background: linear-gradient(135deg, rgba(59, 130, 246, 0.05), rgba(255, 255, 255, 1)); }
  .pillar-P3 { border-left: 4px solid #ef4444; background: linear-gradient(135deg, rgba(239, 68, 68, 0.05), rgba(255, 255, 255, 1)); }
  .pillar-P4 { border-left: 4px solid #ec4899; background: linear-gradient(135deg, rgba(236, 72, 153, 0.05), rgba(255, 255, 255, 1)); }
  .pillar-P5 { border-left: 4px solid #f59e0b; background: linear-gradient(135deg, rgba(245, 158, 11, 0.05), rgba(255, 255, 255, 1)); }
  .pillar-P6 { border-left: 4px solid #22c55e; background: linear-gradient(135deg, rgba(34, 197, 94, 0.05), rgba(255, 255, 255, 1)); }
  .pillar-P7 { border-left: 4px solid #8b5cf6; background: linear-gradient(135deg, rgba(139, 92, 246, 0.05), rgba(255, 255, 255, 1)); }
  .pillar-P8 { border-left: 4px solid #f97316; background: linear-gradient(135deg, rgba(249, 115, 22, 0.05), rgba(255, 255, 255, 1)); }
  .pillar-P9 { border-left: 4px solid #06b6d4; background: linear-gradient(135deg, rgba(6, 182, 212, 0.05), rgba(255, 255, 255, 1)); }
  .pillar-P10 { border-left: 4px solid #64748b; background: linear-gradient(135deg, rgba(100, 116, 139, 0.05), rgba(255, 255, 255, 1)); }
  
  @keyframes cardEnter {
    from {
      opacity: 0;
      transform: scale(0.9) translateY(20px);
    }
    to {
      opacity: 1;
      transform: scale(1) translateY(0);
    }
  }
  
  @keyframes fadeInUp {
    from {
      opacity: 0;
      transform: translateY(15px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
</style>
