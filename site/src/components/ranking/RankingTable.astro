---
import { getRankingWithCandidates, getCriticalRankingWithCandidates, getPriorityRankingWithCandidates } from '../../lib/data';
import ScoreBar from '../ui/ScoreBar.astro';
import FiscalRiskBadge from '../ui/FiscalRiskBadge.astro';

interface Props {
  type?: 'overall' | 'critical' | 'priority';
  class?: string;
  showFiscal?: boolean;
}

const { type = 'overall', class: className = '', showFiscal = true } = Astro.props;

// Funci√≥n para obtener prioridad de riesgo (BAJO = 0, MEDIO = 1, ALTO = 2)
function getRiskPriority(riskLevel: string): number {
  if (riskLevel === 'BAJO') return 0;
  if (riskLevel === 'MEDIO') return 1;
  return 2; // ALTO
}

// Obtener ranking base
const rawRanking = type === 'overall' 
  ? getRankingWithCandidates()
  : type === 'priority'
    ? getPriorityRankingWithCandidates()
    : getCriticalRankingWithCandidates();

// Para ranking overall, reordenar priorizando riesgo BAJO y luego puntaje
const ranking = type === 'overall' 
  ? [...rawRanking].sort((a, b) => {
      const riskA = getRiskPriority(a.analysis?.risk_level || 'BAJO');
      const riskB = getRiskPriority(b.analysis?.risk_level || 'BAJO');
      
      // Primero ordenar por riesgo (BAJO primero)
      if (riskA !== riskB) return riskA - riskB;
      
      // Si mismo riesgo, ordenar por puntaje descendente
      const scoreA = a.weighted_sum || 0;
      const scoreB = b.weighted_sum || 0;
      return scoreB - scoreA;
    }).map((entry, index) => ({ ...entry, rank: index + 1 })) // Recalcular rank
  : rawRanking;

const title = type === 'overall' 
  ? 'Ranking General Ponderado'
  : type === 'priority'
    ? 'Ranking Pilares Prioritarios'
    : 'Ranking Pilares Cr√≠ticos';

const description = type === 'overall'
  ? 'Ordenado por responsabilidad fiscal (riesgo BAJO primero) y puntaje ponderado'
  : type === 'priority'
    ? 'Solo P3 (Seguridad), P4 (Salud), P1 (Finanzas), P7 (Reforma) - 60% del peso'
    : 'Pilares P1-P5, P7 y P10 (81% del peso total)';

// Funci√≥n para obtener el nivel y color seg√∫n el puntaje
function getScoreLevel(scorePercent: number): { label: string; color: string; bgColor: string; emoji: string } {
  if (scorePercent >= 70) return { label: 'Excelente', color: 'text-emerald-700', bgColor: 'bg-emerald-50', emoji: 'üü¢' };
  if (scorePercent >= 55) return { label: 'Bueno', color: 'text-green-600', bgColor: 'bg-green-50', emoji: 'üü°' };
  if (scorePercent >= 40) return { label: 'Regular', color: 'text-amber-600', bgColor: 'bg-amber-50', emoji: 'üü†' };
  return { label: 'Bajo', color: 'text-red-600', bgColor: 'bg-red-50', emoji: 'üî¥' };
}
---

<div class={`${className}`}>
  <div class="mb-4">
    <h2 class="text-2xl font-bold text-slate-900">{title}</h2>
    <p class="text-slate-600 text-sm mt-1">{description}</p>
  </div>
  
  <!-- Leyenda de riesgo fiscal para Ranking General -->
  {type === 'overall' && showFiscal && (
    <div class="mb-4 p-4 bg-gradient-to-r from-green-50 to-slate-50 rounded-lg border border-slate-200">
      <h4 class="text-sm font-semibold text-slate-700 mb-3">‚öñÔ∏è Riesgo Fiscal - Significado de los colores</h4>
      <p class="text-xs text-slate-600 mb-3">
        El riesgo fiscal eval√∫a si las propuestas del candidato amenazan la estabilidad financiera de Costa Rica. 
        <strong class="text-green-700">Un riesgo BAJO es positivo</strong> e indica propuestas fiscalmente responsables.
      </p>
      <div class="flex flex-wrap gap-3 text-xs">
        <div class="flex items-center gap-2 px-3 py-2 bg-green-100 rounded-lg border border-green-300 shadow-sm">
          <span class="text-lg">üü¢</span>
          <div>
            <span class="font-bold text-green-800">BAJO</span>
            <span class="text-green-700 ml-1">‚Ä¢ Fiscalmente responsable</span>
          </div>
        </div>
        <div class="flex items-center gap-2 px-3 py-2 bg-amber-50 rounded-lg border border-amber-200">
          <span class="text-lg">üü†</span>
          <div>
            <span class="font-bold text-amber-700">MEDIO</span>
            <span class="text-amber-600 ml-1">‚Ä¢ Algunas propuestas riesgosas</span>
          </div>
        </div>
        <div class="flex items-center gap-2 px-3 py-2 bg-red-50 rounded-lg border border-red-200">
          <span class="text-lg">üî¥</span>
          <div>
            <span class="font-bold text-red-700">ALTO</span>
            <span class="text-red-600 ml-1">‚Ä¢ Amenaza la estabilidad fiscal</span>
          </div>
        </div>
      </div>
      <div class="mt-3 pt-3 border-t border-slate-200">
        <p class="text-xs text-slate-500">
          <strong>Penalizaciones:</strong> Atacar regla fiscal (-2), Proponer m√°s deuda (-1), Proponer m√°s impuestos (-1)
        </p>
      </div>
    </div>
  )}
  
  <!-- Leyenda de colores para Pilares Cr√≠ticos/Prioritarios -->
  {(type === 'critical' || type === 'priority') && (
    <div class="mb-4 p-4 bg-slate-50 rounded-lg border border-slate-200">
      <h4 class="text-sm font-semibold text-slate-700 mb-3">üìä Significado de los colores</h4>
      <div class="flex flex-wrap gap-3 text-xs">
        <div class="flex items-center gap-2 px-3 py-1.5 bg-emerald-50 rounded-full border border-emerald-200">
          <span>üü¢</span>
          <span class="font-medium text-emerald-700">Excelente (‚â•70%)</span>
          <span class="text-emerald-600">Propuestas s√≥lidas y bien estructuradas</span>
        </div>
        <div class="flex items-center gap-2 px-3 py-1.5 bg-green-50 rounded-full border border-green-200">
          <span>üü°</span>
          <span class="font-medium text-green-700">Bueno (55-69%)</span>
          <span class="text-green-600">Propuestas adecuadas con √°reas de mejora</span>
        </div>
        <div class="flex items-center gap-2 px-3 py-1.5 bg-amber-50 rounded-full border border-amber-200">
          <span>üü†</span>
          <span class="font-medium text-amber-700">Regular (40-54%)</span>
          <span class="text-amber-600">Propuestas incompletas o poco detalladas</span>
        </div>
        <div class="flex items-center gap-2 px-3 py-1.5 bg-red-50 rounded-full border border-red-200">
          <span>üî¥</span>
          <span class="font-medium text-red-700">Bajo (&lt;40%)</span>
          <span class="text-red-600">Propuestas insuficientes o ausentes</span>
        </div>
      </div>
    </div>
  )}
  
  <div class="card overflow-hidden">
    <div class="overflow-x-auto">
      <table class="table-ranking w-full">
        <thead>
          <tr class="bg-slate-50">
            <th class="px-4 py-3 w-14 text-left">#</th>
            <th class="px-4 py-3 text-left">Partido</th>
            {showFiscal && type === 'overall' && (
              <th class="px-4 py-3 w-32 text-center hidden sm:table-cell">Riesgo</th>
            )}
            {showFiscal && type === 'overall' && (
              <th class="px-4 py-3 w-28 text-center hidden lg:table-cell">Penalizaci√≥n</th>
            )}
            {(type === 'critical' || type === 'priority') && (
              <th class="px-4 py-3 w-28 text-center hidden sm:table-cell">Nivel</th>
            )}
            <th class="px-4 py-3 w-32 hidden md:table-cell">Barra</th>
            <th class="px-4 py-3 w-24 text-right">Puntaje</th>
          </tr>
        </thead>
        <tbody>
          {ranking.map((entry, index) => {
            const score = entry.weighted_sum || entry.priority_weighted_sum || entry.critical_weighted_sum || 0;
            const scorePercent = Math.round(score * 100);
            const fiscalPenalty = (entry as any).fiscal_penalty || 0;
            const riskLevel = entry.analysis?.risk_level || 'BAJO';
            const fiscalFlags = entry.analysis?.fiscal_responsibility;
            const scoreLevel = getScoreLevel(scorePercent);
            
            // Para ranking overall, usar riesgo fiscal; para otros, usar nivel por puntaje
            const displayColor = type === 'overall' 
              ? (riskLevel === 'BAJO' ? 'text-green-600' : riskLevel === 'MEDIO' ? 'text-amber-600' : 'text-red-600')
              : scoreLevel.color;
            
            return (
              <tr class="group border-b border-slate-100 hover:bg-slate-50 transition-colors">
                <td class="px-4 py-3">
                  <span class={`
                    w-8 h-8 rounded-full flex items-center justify-center font-bold text-sm
                    ${index === 0 ? 'bg-amber-100 text-amber-700' : 
                      index === 1 ? 'bg-slate-200 text-slate-600' :
                      index === 2 ? 'bg-orange-100 text-orange-700' :
                      'bg-slate-100 text-slate-500'}
                  `}>
                    {entry.rank}
                  </span>
                </td>
                <td class="px-4 py-3">
                  <a
                    href={`/candidatos/${entry.candidate_id}`}
                    class="group-hover:text-civic-600 transition-colors"
                  >
                    <div class="font-medium text-slate-900">
                      {entry.candidate?.party_name || entry.candidate_id.toUpperCase()}
                    </div>
                    <div class="text-sm text-slate-500">{entry.candidate?.pdf_id || entry.candidate_id.toUpperCase()}</div>
                  </a>
                </td>
                {showFiscal && type === 'overall' && (
                  <td class="px-4 py-3 text-center hidden sm:table-cell">
                    <FiscalRiskBadge riskLevel={riskLevel} size="sm" />
                  </td>
                )}
                {showFiscal && type === 'overall' && (
                  <td class="px-4 py-3 text-center hidden lg:table-cell">
                    {fiscalPenalty < 0 ? (
                      <span class="inline-flex items-center gap-1 px-2 py-1 bg-red-50 text-red-700 rounded text-sm font-medium">
                        {fiscalPenalty}
                      </span>
                    ) : (
                      <span class="inline-flex items-center gap-1 px-2 py-1 bg-green-50 text-green-700 rounded text-sm font-medium">
                        0
                      </span>
                    )}
                  </td>
                )}
                {(type === 'critical' || type === 'priority') && (
                  <td class="px-4 py-3 text-center hidden sm:table-cell">
                    <span class={`inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-xs font-medium ${scoreLevel.bgColor} ${scoreLevel.color} border border-current/20`}>
                      <span>{scoreLevel.emoji}</span>
                      <span>{scoreLevel.label}</span>
                    </span>
                  </td>
                )}
                <td class="px-4 py-3 hidden md:table-cell">
                  <ScoreBar score={Math.round(score * 4)} max={4} showLabel={false} size="sm" />
                </td>
                <td class="px-4 py-3 text-right">
                  <span class={`font-bold text-lg ${displayColor}`}>{scorePercent}%</span>
                </td>
              </tr>
            );
          })}
        </tbody>
      </table>
    </div>
  </div>
</div>
