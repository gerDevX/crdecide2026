---
import type { CandidateScore, PillarId } from '../../lib/types';
import { PILLAR_ICONS, CRITICAL_PILLARS, PRIORITY_PILLARS } from '../../lib/types';
import { pillarIndex } from '../../lib/data';
import ScoreBar from '../ui/ScoreBar.astro';

interface Props {
  score: CandidateScore;
  class?: string;
}

const { score, class: className = '' } = Astro.props;
---

<div class={`space-y-3 ${className}`}>
  {score.pillar_scores.map((ps) => {
    const pillar = pillarIndex[ps.pillar_id];
    const icon = PILLAR_ICONS[ps.pillar_id as PillarId] || 'üìå';
    const isPriority = PRIORITY_PILLARS.includes(ps.pillar_id as PillarId);
    const isCritical = CRITICAL_PILLARS.includes(ps.pillar_id as PillarId);
    const hasPenalty = ps.penalties && ps.penalties.length > 0;
    const penaltyAmount = ps.penalties?.reduce((sum, p) => sum + (p.value || 0), 0) || 0;
    
    return (
      <div class={`card p-4 border-l-4 ${hasPenalty ? 'border-red-400 bg-red-50/50' : `pillar-${ps.pillar_id}`}`}>
        <div class="flex items-center justify-between mb-2">
          <div class="flex items-center gap-2 flex-wrap">
            <span class="text-lg">{icon}</span>
            <span class="font-medium text-slate-900">{pillar?.pillar_name || ps.pillar_id}</span>
            {isPriority && (
              <span class="text-xs bg-red-100 text-red-700 px-1.5 py-0.5 rounded">Prioritario</span>
            )}
            {!isPriority && isCritical && (
              <span class="text-xs bg-amber-100 text-amber-700 px-1.5 py-0.5 rounded">Cr√≠tico</span>
            )}
            {hasPenalty && (
              <span class="text-xs bg-red-100 text-red-600 px-1.5 py-0.5 rounded font-medium">
                Penalizado ({penaltyAmount})
              </span>
            )}
          </div>
          <div class="text-right">
            <span class={`font-bold ${hasPenalty ? 'text-red-600' : 'text-slate-700'}`}>
              {ps.effective_score}/4
            </span>
            {hasPenalty && ps.raw_score !== ps.effective_score && (
              <span class="text-xs text-slate-400 ml-1">(bruto: {ps.raw_score})</span>
            )}
          </div>
        </div>
        
        <ScoreBar 
          score={ps.effective_score} 
          max={4} 
          showLabel={false} 
          size="md"
        />
        
        {hasPenalty && ps.penalties && (
          <div class="mt-2 text-xs text-red-600">
            {ps.penalties.map(p => (
              <div class="flex items-center gap-1">
                <span>‚ö†Ô∏è</span>
                <span>{p.reason}</span>
              </div>
            ))}
          </div>
        )}
      </div>
    );
  })}
</div>
