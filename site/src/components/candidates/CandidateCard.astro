---
import type { Candidate, CandidateScore, PillarId, FiscalRiskLevel } from '../../lib/types';
import { PILLAR_ICONS } from '../../lib/types';
import ScoreBar from '../ui/ScoreBar.astro';

interface Props {
  candidate: Candidate;
  score: CandidateScore;
  class?: string;
}

const { candidate, score, class: className = '' } = Astro.props;

const weightedSum = score.overall.weighted_sum;
const weightedPercent = Math.round(weightedSum * 100);
const fiscalRisk = score.overall.fiscal_risk_level as FiscalRiskLevel | undefined;
const fiscalEmoji = fiscalRisk === 'BAJO' ? 'ðŸŸ¢' : fiscalRisk === 'MEDIO' ? 'ðŸŸ ' : fiscalRisk === 'ALTO' ? 'ðŸ”´' : '';
---

<a
  href={`/candidatos/${candidate.candidate_id}`}
  class={`candidate-card card block group ${className}`}
>
  <div class="p-5">
    <div class="flex items-start justify-between mb-3">
      <div class="flex-1 min-w-0">
        <div class="flex items-center gap-2">
          <span class="text-xs font-medium text-slate-400 uppercase">{candidate.pdf_id}</span>
          {fiscalEmoji && <span class="text-sm" title={`Riesgo fiscal: ${fiscalRisk}`}>{fiscalEmoji}</span>}
        </div>
        <h3 class="font-semibold text-slate-900 group-hover:text-civic-600 transition-colors truncate">
          {candidate.party_name}
        </h3>
      </div>
      <div class="text-right flex-shrink-0 ml-2">
        <span class="text-2xl font-bold text-civic-600">{weightedPercent}%</span>
      </div>
    </div>
    
    <!-- Mini matrix - 10 pillars -->
    <div class="grid grid-cols-5 gap-1 mb-3">
      {score.pillar_scores.map((ps) => {
        const icon = PILLAR_ICONS[ps.pillar_id as PillarId];
        const opacity = ps.effective_score / 4;
        return (
          <div
            class="pillar-cell aspect-square rounded-md flex items-center justify-center text-xs transition-transform hover:scale-110"
            style={`background-color: rgba(16, 185, 129, ${opacity * 0.7 + 0.1})`}
            title={`${ps.pillar_id}: ${ps.effective_score}/4`}
          >
            <span class="opacity-70">{icon}</span>
          </div>
        );
      })}
    </div>
    
    <ScoreBar score={Math.round(weightedSum * 4)} max={4} showLabel={false} size="sm" />
    
    <div class="mt-3 flex items-center justify-between text-xs text-slate-500">
      <span>{score.pillar_scores.filter(ps => ps.effective_score === 4).length} pilares mÃ¡ximos</span>
      {fiscalRisk && (
        <span class={`font-medium ${fiscalRisk === 'BAJO' ? 'text-green-600' : fiscalRisk === 'MEDIO' ? 'text-amber-600' : 'text-red-600'}`}>
          Riesgo {fiscalRisk.toLowerCase()}
        </span>
      )}
    </div>
  </div>
</a>

<style>
  .candidate-card {
    transition: all 0.2s ease-out;
  }
  
  .candidate-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
  }
  
  .pillar-cell {
    animation: fadeIn 0.3s ease-out backwards;
  }
  
  .pillar-cell:nth-child(1) { animation-delay: 0.02s; }
  .pillar-cell:nth-child(2) { animation-delay: 0.04s; }
  .pillar-cell:nth-child(3) { animation-delay: 0.06s; }
  .pillar-cell:nth-child(4) { animation-delay: 0.08s; }
  .pillar-cell:nth-child(5) { animation-delay: 0.10s; }
  .pillar-cell:nth-child(6) { animation-delay: 0.12s; }
  .pillar-cell:nth-child(7) { animation-delay: 0.14s; }
  .pillar-cell:nth-child(8) { animation-delay: 0.16s; }
  .pillar-cell:nth-child(9) { animation-delay: 0.18s; }
  .pillar-cell:nth-child(10) { animation-delay: 0.20s; }
  
  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: scale(0.8);
    }
    to {
      opacity: 1;
      transform: scale(1);
    }
  }
  
  /* Express mode */
  :global(html[data-mode="express"]) .candidate-card {
    border-radius: 1rem;
    box-shadow: 0 10px 40px -10px rgba(0, 0, 0, 0.15);
  }
  
  :global(html[data-mode="express"]) .pillar-cell {
    border-radius: 0.375rem;
  }
  
  /* Reading mode */
  :global(html[data-mode="reading"]) .candidate-card {
    padding: 0.5rem;
  }
  
  :global(html[data-mode="reading"]) .candidate-card h3 {
    font-size: 1.125rem;
  }
  
  :global(html[data-mode="reading"]) .candidate-card .text-2xl {
    font-size: 1.75rem;
  }
</style>
