---
import BaseLayout from '../../layouts/BaseLayout.astro';
import CandidateMatrix from '../../components/candidates/CandidateMatrix.astro';
import DimensionBadges from '../../components/ui/DimensionBadges.astro';
import EvidenceLink from '../../components/ui/EvidenceLink.astro';
import FiscalRiskBadge from '../../components/ui/FiscalRiskBadge.astro';
import ScoreBar from '../../components/ui/ScoreBar.astro';
import { 
  candidates, 
  getCandidateScore, 
  getCandidateAnalysis,
  getProposalsByCandidate,
  pillarIndex 
} from '../../lib/data';
import { PILLAR_ICONS, PENALTY_LABELS } from '../../lib/types';
import type { PillarId, FiscalRiskLevel } from '../../lib/types';

export function getStaticPaths() {
  return candidates.map(candidate => ({
    params: { id: candidate.candidate_id },
    props: { candidate }
  }));
}

const { candidate } = Astro.props;
const score = getCandidateScore(candidate.candidate_id);
const analysis = getCandidateAnalysis(candidate.candidate_id);
const proposals = getProposalsByCandidate(candidate.candidate_id);

if (!score) {
  return Astro.redirect('/candidatos');
}

const weightedPercent = Math.round(score.overall.weighted_sum * 100);
const criticalPercent = Math.round(score.overall.critical_weighted_sum * 100);
const priorityPercent = Math.round(score.overall.priority_weighted_sum * 100);
const totalPenalties = score.overall.total_penalties_applied;
const riskLevel = (analysis?.risk_level || 'BAJO') as FiscalRiskLevel;
const fiscalFlags = score.fiscal_analysis?.flags;

// Group proposals by pillar
const proposalsByPillar = proposals.reduce((acc, p) => {
  if (!acc[p.pillar_id]) acc[p.pillar_id] = [];
  acc[p.pillar_id].push(p);
  return acc;
}, {} as Record<string, typeof proposals>);

// Get active penalties (v6: removed proposes_tax_increase)
const activePenalties = [
  fiscalFlags?.attacks_fiscal_rule && 'attacks_fiscal_rule',
  fiscalFlags?.proposes_debt_increase && 'proposes_debt_increase',
].filter(Boolean) as string[];

// Get omission penalties from omission_analysis
const omissionAnalysis = score.omission_analysis;
const omissionPenalties: string[] = [];
if (omissionAnalysis?.urgency_coverage) {
  if (!omissionAnalysis.urgency_coverage.security_operations?.covered) {
    omissionPenalties.push('ignores_security');
  }
  if (!omissionAnalysis.urgency_coverage.ccss_crisis?.covered) {
    omissionPenalties.push('ignores_ccss');
  }
  if (!omissionAnalysis.urgency_coverage.formal_employment?.covered) {
    omissionPenalties.push('ignores_employment');
  }
  if (!omissionAnalysis.urgency_coverage.organized_crime?.covered) {
    omissionPenalties.push('ignores_organized_crime');
  }
}
omissionAnalysis?.missing_pillars?.forEach(p => omissionPenalties.push('missing_priority_pillar'));
---

<BaseLayout title={candidate.party_name}>
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    
    <!-- Breadcrumb -->
    <nav class="mb-6 text-sm">
      <a href="/candidatos" class="text-civic-600 hover:underline">‚Üê Candidatos</a>
    </nav>

    <!-- Header -->
    <header class="card p-6 mb-8">
      <div class="flex flex-wrap items-start justify-between gap-6">
        <div>
          <span class="text-sm font-medium text-slate-400 uppercase">{candidate.pdf_id}</span>
          <h1 class="text-3xl font-bold text-slate-900 mt-1">{candidate.party_name}</h1>
          {candidate.candidate_name !== 'no_especificado' && candidate.candidate_name !== 'Por determinar' && (
            <p class="text-lg text-slate-600 mt-1">{candidate.candidate_name}</p>
          )}
        </div>
        <div class="text-right">
          <div class={`text-4xl font-bold ${
            riskLevel === 'BAJO' ? 'text-green-600' :
            riskLevel === 'MEDIO' ? 'text-amber-600' :
            'text-red-600'
          }`}>{weightedPercent}%</div>
          <div class="text-sm text-slate-500">Puntaje ponderado</div>
          <div class="mt-2">
            <FiscalRiskBadge riskLevel={riskLevel} size="md" />
          </div>
        </div>
      </div>
      
      <div class="mt-6 grid sm:grid-cols-4 gap-4">
        <div class="bg-slate-50 rounded-lg p-4">
          <div class="text-2xl font-bold text-slate-900">{score.overall.raw_sum}/40</div>
          <div class="text-sm text-slate-500">Puntaje bruto</div>
        </div>
        <div class="bg-emerald-50 rounded-lg p-4">
          <div class="text-2xl font-bold text-emerald-700">{weightedPercent}%</div>
          <div class="text-sm text-slate-500">Ponderado general</div>
        </div>
        <div class="bg-purple-50 rounded-lg p-4">
          <div class="text-2xl font-bold text-purple-700">{priorityPercent}%</div>
          <div class="text-sm text-slate-500">Pilares prioritarios</div>
        </div>
        <div class={`rounded-lg p-4 ${totalPenalties < 0 ? 'bg-red-50' : 'bg-green-50'}`}>
          <div class={`text-2xl font-bold ${totalPenalties < 0 ? 'text-red-600' : 'text-green-600'}`}>
            {totalPenalties}
          </div>
          <div class="text-sm text-slate-500">Penalizaci√≥n total</div>
        </div>
      </div>
      
      <div class="mt-6 flex flex-wrap gap-3">
        <a
          href={candidate.pdf_url && candidate.pdf_url !== 'no_especificado' ? candidate.pdf_url : `/planes/${candidate.pdf_id}.pdf`}
          target="_blank"
          rel="noopener noreferrer"
          class="btn btn-primary"
        >
          üìÑ Ver plan de gobierno (PDF)
        </a>
        {candidate.pdf_url && candidate.pdf_url.includes('tse.go.cr') && (
          <span class="inline-flex items-center text-xs text-green-600 bg-green-50 px-2 py-1 rounded">
            ‚úì Fuente oficial TSE
          </span>
        )}
        <a href={`/comparar?c=${candidate.candidate_id}`} class="btn btn-secondary">
          Comparar con otros
        </a>
      </div>
    </header>

    <!-- Fiscal Alerts Section -->
    {activePenalties.length > 0 && (
      <section class="card p-6 mb-8 bg-red-50 border-red-200">
        <h2 class="text-xl font-bold text-red-800 mb-4">‚ö†Ô∏è Alertas Fiscales</h2>
        <p class="text-sm text-red-700 mb-4">
          Este plan de gobierno tiene <strong>{activePenalties.length}</strong> bandera(s) roja(s) fiscal(es):
        </p>
        <div class="grid gap-3">
          {activePenalties.map(flag => (
            <div class="flex items-start gap-3 bg-white p-3 rounded-lg border border-red-200">
              <span class="text-2xl">{PENALTY_LABELS[flag]?.emoji}</span>
              <div>
                <h4 class="font-semibold text-red-800">{PENALTY_LABELS[flag]?.label}</h4>
                <p class="text-sm text-red-600">{PENALTY_LABELS[flag]?.description}</p>
              </div>
            </div>
          ))}
        </div>
        {score.fiscal_analysis?.evidence && score.fiscal_analysis.evidence.length > 0 && (
          <div class="mt-4">
            <h4 class="font-semibold text-red-800 mb-2">Evidencia del documento:</h4>
            <div class="space-y-2">
              {score.fiscal_analysis.evidence.slice(0, 2).map(ev => (
                <blockquote class="text-sm text-red-700 bg-white p-3 rounded border-l-4 border-red-400 italic">
                  "{ev}"
                </blockquote>
              ))}
            </div>
          </div>
        )}
      </section>
    )}

    <!-- Omission Alerts Section -->
    {omissionPenalties.length > 0 && (
      <section class="card p-6 mb-8 bg-amber-50 border-amber-200">
        <h2 class="text-xl font-bold text-amber-800 mb-4">‚ö†Ô∏è Urgencias Nacionales No Abordadas</h2>
        <p class="text-sm text-amber-700 mb-4">
          Este plan de gobierno no menciona <strong>{omissionPenalties.length}</strong> tema(s) cr√≠tico(s) 
          para Costa Rica:
        </p>
        <div class="grid gap-3">
          {omissionPenalties.map(flag => (
            <div class="flex items-start gap-3 bg-white p-3 rounded-lg border border-amber-200">
              <span class="text-2xl">{PENALTY_LABELS[flag]?.emoji}</span>
              <div>
                <h4 class="font-semibold text-amber-800">{PENALTY_LABELS[flag]?.label}</h4>
                <p class="text-sm text-amber-600">{PENALTY_LABELS[flag]?.description}</p>
              </div>
            </div>
          ))}
        </div>
      </section>
    )}

    <!-- Fiscal Responsibility if good -->
    {fiscalFlags?.shows_fiscal_responsibility && riskLevel === 'BAJO' && (
      <section class="card p-6 mb-8 bg-green-50 border-green-200">
        <h2 class="text-xl font-bold text-green-800 mb-2">‚úÖ Responsabilidad Fiscal</h2>
        <p class="text-sm text-green-700">
          Este plan de gobierno muestra indicadores de responsabilidad fiscal y no presenta 
          banderas rojas que comprometan las finanzas p√∫blicas de Costa Rica.
        </p>
      </section>
    )}

    <!-- Strengths & Weaknesses -->
    {analysis && (analysis.strengths.length > 0 || analysis.weaknesses.length > 0) && (
      <section class="grid md:grid-cols-2 gap-6 mb-8">
        {analysis.strengths.length > 0 && (
          <div class="card p-5 border-l-4 border-green-500">
            <h3 class="font-bold text-green-800 mb-3">üí™ Fortalezas</h3>
            <ul class="space-y-2 text-sm">
              {analysis.strengths.map(s => (
                <li class="flex items-start gap-2 text-green-700">
                  <span class="text-green-500">‚úì</span>
                  <span>{s}</span>
                </li>
              ))}
            </ul>
          </div>
        )}
        {analysis.weaknesses.length > 0 && (
          <div class="card p-5 border-l-4 border-red-500">
            <h3 class="font-bold text-red-800 mb-3">‚ö†Ô∏è Debilidades</h3>
            <ul class="space-y-2 text-sm">
              {analysis.weaknesses.map(w => (
                <li class="flex items-start gap-2 text-red-700">
                  <span class="text-red-500">‚úó</span>
                  <span>{w}</span>
                </li>
              ))}
            </ul>
          </div>
        )}
      </section>
    )}

    <!-- Matrix -->
    <section class="mb-12">
      <h2 class="text-2xl font-bold text-slate-900 mb-4">Evaluaci√≥n por Pilar</h2>
      <CandidateMatrix score={score} />
    </section>

    <!-- Proposals by Pillar -->
    <section>
      <h2 class="text-2xl font-bold text-slate-900 mb-4">Propuestas por Pilar</h2>
      
      <div class="space-y-8">
        {score.pillar_scores.map((ps) => {
          const pillar = pillarIndex[ps.pillar_id];
          const icon = PILLAR_ICONS[ps.pillar_id as PillarId];
          const pillarProposals = (proposalsByPillar[ps.pillar_id] || [])
            .sort((a, b) => {
              const scoreA = a.dimensions.existence + a.dimensions.when + a.dimensions.how + a.dimensions.funding;
              const scoreB = b.dimensions.existence + b.dimensions.when + b.dimensions.how + b.dimensions.funding;
              return scoreB - scoreA;
            })
            .slice(0, 3);
          
          const hasPenalties = ps.penalties && ps.penalties.length > 0;
          
          return (
            <div>
              <div class="flex items-center gap-2 mb-3">
                <span class="text-xl">{icon}</span>
                <h3 class="font-semibold text-slate-900">{pillar?.pillar_name || ps.pillar_id}</h3>
                <span class={`text-sm ${hasPenalties ? 'text-red-600' : 'text-slate-500'}`}>
                  ({ps.effective_score}/4)
                  {hasPenalties && ps.raw_score !== ps.effective_score && (
                    <span class="text-xs ml-1">(bruto: {ps.raw_score})</span>
                  )}
                </span>
                {hasPenalties && (
                  <span class="text-xs bg-red-100 text-red-700 px-2 py-0.5 rounded">
                    Penalizado
                  </span>
                )}
              </div>
              
              {pillarProposals.length > 0 ? (
                <div class="space-y-3">
                  {pillarProposals.map((proposal) => (
                    <div class={`card p-4 border-l-4 ${hasPenalties ? 'border-red-400' : `pillar-${ps.pillar_id}`}`}>
                      <h4 class="font-medium text-slate-900 mb-2">{proposal.proposal_title}</h4>
                      <p class="text-sm text-slate-600 mb-3 line-clamp-2">{proposal.proposal_text}</p>
                      <div class="flex flex-wrap items-center justify-between gap-3">
                        <DimensionBadges dimensions={proposal.dimensions} compact={true} />
                        <EvidenceLink 
                          pdfId={proposal.evidence.pdf_id}
                          page={proposal.evidence.page}
                          compact={true}
                        />
                      </div>
                    </div>
                  ))}
                </div>
              ) : (
                <p class="text-slate-500 text-sm italic">
                  No se encontraron propuestas concretas para este pilar.
                </p>
              )}
            </div>
          );
        })}
      </div>
    </section>

  </div>
</BaseLayout>
