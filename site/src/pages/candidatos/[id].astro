---
import BaseLayout from '../../layouts/BaseLayout.astro';
import CandidateMatrix from '../../components/candidates/CandidateMatrix.astro';
import DimensionBadges from '../../components/ui/DimensionBadges.astro';
import EvidenceLink from '../../components/ui/EvidenceLink.astro';
import ScoreBar from '../../components/ui/ScoreBar.astro';
import { 
  candidates, 
  getCandidateScore, 
  getProposalsByCandidate,
  pillarIndex 
} from '../../lib/data';
import { PILLAR_ICONS } from '../../lib/types';
import type { PillarId } from '../../lib/types';

export function getStaticPaths() {
  return candidates.map(candidate => ({
    params: { id: candidate.candidate_id },
    props: { candidate }
  }));
}

const { candidate } = Astro.props;
const score = getCandidateScore(candidate.candidate_id);
const proposals = getProposalsByCandidate(candidate.candidate_id);

if (!score) {
  return Astro.redirect('/candidatos');
}

const weightedPercent = Math.round(score.overall.weighted_sum * 100);
const criticalPercent = Math.round(score.overall.coverage_critical_weighted_sum * 100);

// Group proposals by pillar
const proposalsByPillar = proposals.reduce((acc, p) => {
  if (!acc[p.pillar_id]) acc[p.pillar_id] = [];
  acc[p.pillar_id].push(p);
  return acc;
}, {} as Record<string, typeof proposals>);
---

<BaseLayout title={candidate.party_name}>
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    
    <!-- Breadcrumb -->
    <nav class="mb-6 text-sm">
      <a href="/candidatos" class="text-civic-600 hover:underline">‚Üê Candidatos</a>
    </nav>

    <!-- Header -->
    <header class="card p-6 mb-8">
      <div class="flex flex-wrap items-start justify-between gap-6">
        <div>
          <span class="text-sm font-medium text-slate-400 uppercase">{candidate.pdf_id}</span>
          <h1 class="text-3xl font-bold text-slate-900 mt-1">{candidate.party_name}</h1>
          {candidate.candidate_name !== 'Por determinar' && (
            <p class="text-lg text-slate-600 mt-1">{candidate.candidate_name}</p>
          )}
        </div>
        <div class="text-right">
          <div class="text-4xl font-bold text-civic-600">{weightedPercent}%</div>
          <div class="text-sm text-slate-500">Puntaje ponderado</div>
        </div>
      </div>
      
      <div class="mt-6 grid sm:grid-cols-3 gap-4">
        <div class="bg-slate-50 rounded-lg p-4">
          <div class="text-2xl font-bold text-slate-900">{score.overall.raw_sum}/36</div>
          <div class="text-sm text-slate-500">Puntaje bruto</div>
        </div>
        <div class="bg-emerald-50 rounded-lg p-4">
          <div class="text-2xl font-bold text-emerald-700">{weightedPercent}%</div>
          <div class="text-sm text-slate-500">Ponderado general</div>
        </div>
        <div class="bg-amber-50 rounded-lg p-4">
          <div class="text-2xl font-bold text-amber-700">{criticalPercent}%</div>
          <div class="text-sm text-slate-500">Pilares cr√≠ticos</div>
        </div>
      </div>
      
      <div class="mt-6 flex flex-wrap gap-3">
        <a
          href={`/planes/${candidate.pdf_id}.pdf`}
          target="_blank"
          rel="noopener noreferrer"
          class="btn btn-primary"
        >
          üìÑ Ver plan de gobierno (PDF)
        </a>
        <a href={`/comparar?c=${candidate.candidate_id}`} class="btn btn-secondary">
          Comparar con otros
        </a>
      </div>
      
      {score.overall.notes && (
        <div class="mt-4 text-sm text-slate-600 bg-slate-50 p-3 rounded-lg">
          <strong>Notas:</strong> {score.overall.notes}
        </div>
      )}
    </header>

    <!-- Matrix -->
    <section class="mb-12">
      <h2 class="text-2xl font-bold text-slate-900 mb-4">Evaluaci√≥n por Pilar</h2>
      <CandidateMatrix score={score} showDetail={true} />
    </section>

    <!-- Proposals by Pillar -->
    <section>
      <h2 class="text-2xl font-bold text-slate-900 mb-4">Propuestas por Pilar</h2>
      
      <div class="space-y-8">
        {score.pillar_scores.map((ps) => {
          const pillar = pillarIndex[ps.pillar_id];
          const icon = PILLAR_ICONS[ps.pillar_id as PillarId];
          const pillarProposals = (proposalsByPillar[ps.pillar_id] || [])
            .sort((a, b) => {
              const scoreA = a.dimensions.existence + a.dimensions.when + a.dimensions.how + a.dimensions.funding;
              const scoreB = b.dimensions.existence + b.dimensions.when + b.dimensions.how + b.dimensions.funding;
              return scoreB - scoreA;
            })
            .slice(0, 3);
          
          return (
            <div>
              <div class="flex items-center gap-2 mb-3">
                <span class="text-xl">{icon}</span>
                <h3 class="font-semibold text-slate-900">{pillar.pillar_name}</h3>
                <span class="text-sm text-slate-500">({ps.effective_score}/4)</span>
              </div>
              
              {pillarProposals.length > 0 ? (
                <div class="space-y-3">
                  {pillarProposals.map((proposal) => (
                    <div class={`card p-4 border-l-4 pillar-${ps.pillar_id}`}>
                      <h4 class="font-medium text-slate-900 mb-2">{proposal.proposal_title}</h4>
                      <p class="text-sm text-slate-600 mb-3 line-clamp-2">{proposal.proposal_text}</p>
                      <div class="flex flex-wrap items-center justify-between gap-3">
                        <DimensionBadges dimensions={proposal.dimensions} compact={true} />
                        <EvidenceLink 
                          pdfId={proposal.evidence.pdf_id}
                          page={proposal.evidence.page}
                          compact={true}
                        />
                      </div>
                    </div>
                  ))}
                </div>
              ) : (
                <p class="text-slate-500 text-sm italic">
                  No se encontraron propuestas concretas para este pilar.
                </p>
              )}
            </div>
          );
        })}
      </div>
    </section>

  </div>
</BaseLayout>
