---
import BaseLayout from '../layouts/BaseLayout.astro';
import { SpotlightCard } from '../components/ui/aceternity/SpotlightCard';
import { 
  candidates, 
  scoresByCandidate, 
  pillars, 
  analysisByCandidate, 
  proposals
} from '../lib/data';

// Helper para obtener nombre del candidato
function getCandidateName(candidate) {
  const name = candidate?.candidate_name;
  if (name && name !== 'Por determinar' && name !== 'no_especificado') {
    return name;
  }
  return candidate?.party_name || 'N/A';
}

// Sort candidates by score for selector
const sortedCandidates = [...candidates].sort((a, b) => {
  const scoreA = scoresByCandidate[a.candidate_id]?.overall.weighted_sum || 0;
  const scoreB = scoresByCandidate[b.candidate_id]?.overall.weighted_sum || 0;
  return scoreB - scoreA;
});

// Prepare candidate data with names
const candidatesWithNames = sortedCandidates.map(c => ({
  ...c,
  displayName: getCandidateName(c)
}));
---

<BaseLayout title="Comparar Candidatos">

  <!-- ============================================
       DASHBOARD MODE - Modo Visual Detallado
       ============================================ -->
  <div class="mode-dashboard-content">
    <div class="dashboard-compare-wrapper">
      
      <!-- Header -->
      <header class="dashboard-compare-header">
        <h1 class="dashboard-compare-title">‚öñÔ∏è Comparar Candidatos</h1>
        <p class="dashboard-compare-subtitle">
          Selecciona de 2 a 4 candidatos para comparar sus propuestas lado a lado.
        </p>
      </header>

      <!-- Candidate Selector -->
      <div class="dashboard-compare-selector">
        <div class="dashboard-compare-selector-header">
          <span class="dashboard-compare-selector-label">Selecciona candidatos:</span>
          <button id="dashboard-clear-btn" class="dashboard-compare-clear-btn hidden">
            ‚úï Limpiar
          </button>
        </div>
        <div id="dashboard-candidate-grid" class="dashboard-compare-candidate-grid">
          {candidatesWithNames.map((candidate) => (
            <button
              data-candidate-id={candidate.candidate_id}
              data-candidate-name={candidate.displayName}
              data-party-name={candidate.party_name}
              class="dashboard-compare-candidate-btn"
            >
              <span class="dashboard-compare-candidate-name">{candidate.displayName}</span>
              <span class="dashboard-compare-candidate-party">{candidate.party_name}</span>
            </button>
          ))}
        </div>
        <p id="dashboard-selection-hint" class="dashboard-compare-hint">
          Haz clic en los candidatos que deseas comparar (m√≠nimo 2, m√°ximo 4)
        </p>
      </div>

      <!-- Comparison Container -->
      <div id="dashboard-comparison-container" class="dashboard-compare-container hidden">
        <!-- Resumen Comparativo -->
        <div id="dashboard-comparative-summary" class="dashboard-compare-section">
          <!-- Filled by JS -->
        </div>
        
        <!-- Penalizaciones -->
        <div id="dashboard-penalties-comparison" class="dashboard-compare-section">
          <h3 class="dashboard-compare-section-title">‚öñÔ∏è Penalizaciones Aplicadas</h3>
          <div id="dashboard-penalties-content">
            <!-- Filled by JS -->
          </div>
        </div>
        
        <!-- Bonos -->
        <div id="dashboard-bonuses-comparison" class="dashboard-compare-section">
          <h3 class="dashboard-compare-section-title">üéÅ Bonos Aplicados</h3>
          <div id="dashboard-bonuses-content">
            <!-- Filled by JS -->
          </div>
        </div>
        
        <!-- Informaci√≥n Adicional -->
        <div id="dashboard-flags-comparison" class="dashboard-compare-section">
          <h3 class="dashboard-compare-section-title">‚ÑπÔ∏è Informaci√≥n Adicional</h3>
          <div id="dashboard-flags-content">
            <!-- Filled by JS -->
          </div>
        </div>
        
        <!-- Cobertura de Urgencias -->
        <div id="dashboard-urgency-comparison" class="dashboard-compare-section">
          <h3 class="dashboard-compare-section-title">üö® Cobertura de Urgencias Nacionales</h3>
          <div id="dashboard-urgency-content">
            <!-- Filled by JS -->
          </div>
        </div>
      </div>

      <!-- Empty State -->
      <div id="dashboard-empty-state" class="dashboard-compare-empty">
        <span class="dashboard-compare-empty-icon">üîç</span>
        <span class="dashboard-compare-empty-text">Selecciona al menos 2 candidatos</span>
      </div>

    </div>
  </div>

  <!-- ============================================
       EXPRESS MODE - Modo Visual R√°pido
       ============================================ -->
  <div class="mode-express-content">
    <div class="express-compare-wrapper">
      
      <!-- Header -->
      <header class="express-compare-header">
        <h1 class="express-compare-title">‚öñÔ∏è Comparar</h1>
        <p class="express-compare-subtitle">Selecciona 2-4 candidatos</p>
      </header>

      <!-- Candidate Selector -->
      <div class="express-compare-selector">
        <div class="express-compare-selector-header">
          <span class="express-compare-selector-label">Candidatos:</span>
          <button id="express-clear-btn" class="express-compare-clear-btn hidden">
            ‚úï
          </button>
        </div>
        <div id="express-candidate-grid" class="express-compare-candidate-grid">
          {candidatesWithNames.map((candidate) => (
            <button
              data-candidate-id={candidate.candidate_id}
              data-candidate-name={candidate.displayName}
              data-party-name={candidate.party_name}
              class="express-compare-candidate-btn"
            >
              <span class="express-compare-candidate-name">{candidate.displayName}</span>
              <span class="express-compare-candidate-party">{candidate.party_name}</span>
            </button>
          ))}
        </div>
        <p id="express-selection-hint" class="express-compare-hint">
          M√≠nimo 2, m√°ximo 4 candidatos
        </p>
      </div>

      <!-- Comparison Container -->
      <div id="express-comparison-container" class="express-compare-container hidden">
        <!-- Resumen Comparativo -->
        <div id="express-comparative-summary" class="express-compare-section">
          <!-- Filled by JS -->
        </div>
        
        <!-- Penalizaciones -->
        <div id="express-penalties-comparison" class="express-compare-section">
          <h3 class="express-compare-section-title">‚öñÔ∏è Penalizaciones</h3>
          <div id="express-penalties-content">
            <!-- Filled by JS -->
          </div>
        </div>
        
        <!-- Bonos -->
        <div id="express-bonuses-comparison" class="express-compare-section">
          <h3 class="express-compare-section-title">üéÅ Bonos</h3>
          <div id="express-bonuses-content">
            <!-- Filled by JS -->
          </div>
        </div>
        
        <!-- Informaci√≥n Adicional -->
        <div id="express-flags-comparison" class="express-compare-section">
          <h3 class="express-compare-section-title">‚ÑπÔ∏è Informaci√≥n Adicional</h3>
          <div id="express-flags-content">
            <!-- Filled by JS -->
          </div>
        </div>
        
        <!-- Cobertura de Urgencias -->
        <div id="express-urgency-comparison" class="express-compare-section">
          <h3 class="express-compare-section-title">üö® Urgencias</h3>
          <div id="express-urgency-content">
            <!-- Filled by JS -->
          </div>
        </div>
      </div>

      <!-- Empty State -->
      <div id="express-empty-state" class="express-compare-empty">
        <span class="express-compare-empty-icon">üîç</span>
        <span class="express-compare-empty-text">Selecciona 2+ candidatos</span>
      </div>

    </div>
  </div>

  <!-- ============================================
       READING MODE - Modo Lectura
       ============================================ -->
  <div class="mode-reading-content">
    <div class="reading-compare-wrapper">
      
      <!-- Header -->
      <header class="reading-compare-header">
        <h1 class="reading-compare-title">‚öñÔ∏è Comparar Candidatos</h1>
        <p class="reading-compare-subtitle">
          Esta herramienta le permite comparar las propuestas de varios candidatos lado a lado.
        </p>
      </header>

      <!-- Candidate Selector -->
      <div class="reading-compare-selector">
        <div class="reading-compare-selector-header">
          <span class="reading-compare-selector-label">Seleccione los candidatos a comparar:</span>
          <button id="reading-clear-btn" class="reading-compare-clear-btn hidden">
            ‚úï Limpiar selecci√≥n
          </button>
        </div>
        <div id="reading-candidate-list" class="reading-compare-candidate-list">
          {candidatesWithNames.map((candidate) => (
            <button
              data-candidate-id={candidate.candidate_id}
              data-candidate-name={candidate.displayName}
              data-party-name={candidate.party_name}
              class="reading-compare-candidate-btn"
            >
              <span class="reading-compare-candidate-name">{candidate.displayName}</span>
              <span class="reading-compare-candidate-party">{candidate.party_name}</span>
            </button>
          ))}
        </div>
        <p id="reading-selection-hint" class="reading-compare-hint">
          üí° Seleccione al menos 2 candidatos para poder comparar.
        </p>
      </div>

      <!-- Comparison Container -->
      <div id="reading-comparison-container" class="reading-compare-container hidden">
        <!-- Resumen Comparativo -->
        <div id="reading-comparative-summary" class="reading-compare-section">
          <!-- Filled by JS -->
        </div>
        
        <!-- Penalizaciones -->
        <div id="reading-penalties-comparison" class="reading-compare-section">
          <h3 class="reading-compare-section-title">‚öñÔ∏è Penalizaciones Aplicadas</h3>
          <div id="reading-penalties-content">
            <!-- Filled by JS -->
          </div>
        </div>
        
        <!-- Bonos -->
        <div id="reading-bonuses-comparison" class="reading-compare-section">
          <h3 class="reading-compare-section-title">üéÅ Bonos Aplicados</h3>
          <div id="reading-bonuses-content">
            <!-- Filled by JS -->
          </div>
        </div>
        
        <!-- Informaci√≥n Adicional -->
        <div id="reading-flags-comparison" class="reading-compare-section">
          <h3 class="reading-compare-section-title">‚ÑπÔ∏è Informaci√≥n Adicional</h3>
          <div id="reading-flags-content">
            <!-- Filled by JS -->
          </div>
        </div>
        
        <!-- Cobertura de Urgencias -->
        <div id="reading-urgency-comparison" class="reading-compare-section">
          <h3 class="reading-compare-section-title">üö® Cobertura de Urgencias Nacionales</h3>
          <div id="reading-urgency-content">
            <!-- Filled by JS -->
          </div>
        </div>
      </div>

      <!-- Empty State -->
      <div id="reading-empty-state" class="reading-compare-empty">
        <span class="reading-compare-empty-icon">üîç</span>
        <span class="reading-compare-empty-text">Seleccione al menos 2 candidatos</span>
      </div>

    </div>
  </div>

</BaseLayout>

<style>
  /* ===========================================
     MODE VISIBILITY - Base Rules
     =========================================== */
  
  .mode-dashboard-content {
    display: block;
  }
  
  .mode-express-content,
  .mode-reading-content {
    display: none;
  }
  
  html[data-mode="dashboard"] .mode-dashboard-content {
    display: block !important;
  }
  
  html[data-mode="dashboard"] .mode-express-content,
  html[data-mode="dashboard"] .mode-reading-content {
    display: none !important;
  }
  
  html[data-mode="express"] .mode-express-content {
    display: block !important;
  }
  
  html[data-mode="express"] .mode-dashboard-content,
  html[data-mode="express"] .mode-reading-content {
    display: none !important;
  }
  
  html[data-mode="reading"] .mode-reading-content {
    display: block !important;
  }
  
  html[data-mode="reading"] .mode-dashboard-content,
  html[data-mode="reading"] .mode-express-content {
    display: none !important;
  }
  
  /* Utility class */
  .hidden {
    display: none !important;
  }

  /* ===========================================
     DASHBOARD MODE STYLES
     =========================================== */
  
  .dashboard-compare-wrapper {
    max-width: 7xl;
    margin: 0 auto;
    padding: 2rem 1rem;
  }
  
  .dashboard-compare-header {
    margin-bottom: 2rem;
  }
  
  .dashboard-compare-title {
    font-size: 2rem;
    font-weight: 700;
    color: #0f172a;
    margin-bottom: 0.5rem;
  }
  
  .dashboard-compare-subtitle {
    font-size: 1.125rem;
    color: #64748b;
  }
  
  .dashboard-compare-selector {
    background: white;
    border: 2px solid #e2e8f0;
    border-radius: 1rem;
    padding: 1.5rem;
    margin-bottom: 2rem;
  }
  
  .dashboard-compare-selector-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
  }
  
  .dashboard-compare-selector-label {
    font-weight: 600;
    color: #475569;
  }
  
  .dashboard-compare-clear-btn {
    background: #dc2626;
    color: white;
    border: none;
    border-radius: 0.5rem;
    padding: 0.5rem 1rem;
    font-weight: 600;
    cursor: pointer;
    transition: background 0.2s;
  }
  
  .dashboard-compare-clear-btn:hover {
    background: #b91c1c;
  }
  
  .dashboard-compare-candidate-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 0.75rem;
  }
  
  .dashboard-compare-candidate-btn {
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    padding: 1rem;
    background: white;
    border: 2px solid #e2e8f0;
    border-radius: 0.5rem;
    cursor: pointer;
    transition: all 0.2s;
    text-align: left;
  }
  
  .dashboard-compare-candidate-btn:hover {
    border-color: #0891b2;
  }
  
  .dashboard-compare-candidate-btn.selected {
    background: #ecfeff;
    border-color: #0891b2;
    box-shadow: 0 0 0 3px rgba(8, 145, 178, 0.2);
  }
  
  .dashboard-compare-candidate-name {
    font-size: 0.95rem;
    font-weight: 600;
    color: #0f172a;
    line-height: 1.2;
  }
  
  .dashboard-compare-candidate-party {
    font-size: 0.8rem;
    color: #64748b;
    margin-top: 0.25rem;
  }
  
  .dashboard-compare-hint {
    margin-top: 1rem;
    font-size: 0.875rem;
    color: #64748b;
  }
  
  .dashboard-compare-container {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
  }
  
  .dashboard-compare-section {
    background: white;
    border: 2px solid #e2e8f0;
    border-radius: 1rem;
    padding: 1.5rem;
  }
  
  .dashboard-compare-section-title {
    font-size: 1.25rem;
    font-weight: 700;
    color: #0f172a;
    margin-bottom: 1rem;
  }
  
  .dashboard-compare-empty {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 3rem;
    background: #f8fafc;
    border: 2px dashed #cbd5e1;
    border-radius: 1rem;
    color: #64748b;
  }
  
  .dashboard-compare-empty-icon {
    font-size: 3rem;
    margin-bottom: 1rem;
  }
  
  .dashboard-compare-empty-text {
    font-size: 1.125rem;
  }
  

  /* ===========================================
     EXPRESS MODE STYLES
     =========================================== */
  
  .express-compare-wrapper {
    max-width: 6xl;
    margin: 0 auto;
    padding: 1.5rem 1rem;
  }
  
  .express-compare-header {
    margin-bottom: 1.5rem;
  }
  
  .express-compare-title {
    font-size: 1.5rem;
    font-weight: 700;
    color: #0f172a;
    margin-bottom: 0.25rem;
  }
  
  .express-compare-subtitle {
    font-size: 0.9rem;
    color: #64748b;
  }
  
  .express-compare-selector {
    background: white;
    border: 2px solid #e2e8f0;
    border-radius: 0.75rem;
    padding: 1rem;
    margin-bottom: 1.5rem;
  }
  
  .express-compare-selector-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.75rem;
  }
  
  .express-compare-selector-label {
    font-weight: 600;
    font-size: 0.875rem;
    color: #475569;
  }
  
  .express-compare-clear-btn {
    background: #dc2626;
    color: white;
    border: none;
    border-radius: 0.375rem;
    padding: 0.375rem 0.75rem;
    font-size: 0.875rem;
    font-weight: 600;
    cursor: pointer;
  }
  
  .express-compare-candidate-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
    gap: 0.5rem;
  }
  
  .express-compare-candidate-btn {
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    padding: 0.75rem;
    background: white;
    border: 2px solid #e2e8f0;
    border-radius: 0.5rem;
    cursor: pointer;
    transition: all 0.2s;
    text-align: left;
  }
  
  .express-compare-candidate-btn:hover {
    border-color: #0891b2;
  }
  
  .express-compare-candidate-btn.selected {
    background: #ecfeff;
    border-color: #0891b2;
  }
  
  .express-compare-candidate-name {
    font-size: 0.85rem;
    font-weight: 600;
    color: #0f172a;
    line-height: 1.2;
  }
  
  .express-compare-candidate-party {
    font-size: 0.75rem;
    color: #64748b;
    margin-top: 0.125rem;
  }
  
  .express-compare-hint {
    margin-top: 0.75rem;
    font-size: 0.8rem;
    color: #64748b;
  }
  
  .express-compare-container {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }
  
  .express-compare-section {
    background: white;
    border: 2px solid #e2e8f0;
    border-radius: 0.75rem;
    padding: 1rem;
  }
  
  .express-compare-section-title {
    font-size: 1rem;
    font-weight: 700;
    color: #0f172a;
    margin-bottom: 0.75rem;
  }
  
  .express-compare-empty {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 2rem;
    background: #f8fafc;
    border: 2px dashed #cbd5e1;
    border-radius: 0.75rem;
    color: #64748b;
  }
  
  .express-compare-empty-icon {
    font-size: 2rem;
    margin-bottom: 0.75rem;
  }
  
  .express-compare-empty-text {
    font-size: 0.9rem;
  }
  
  .express-compare-summary {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    gap: 0.75rem;
    margin-bottom: 1rem;
    padding: 0.75rem;
    background: #f8fafc;
    border-radius: 0.5rem;
  }
  
  .express-compare-summary-item {
    text-align: center;
  }
  
  .express-compare-summary-name {
    font-size: 0.8rem;
    font-weight: 600;
    color: #0f172a;
    margin-bottom: 0.25rem;
  }
  
  .express-compare-summary-score {
    font-size: 1.25rem;
    font-weight: 700;
    color: #0891b2;
  }
  

  /* ===========================================
     READING MODE STYLES
     =========================================== */
  
  .reading-compare-wrapper {
    max-width: 5xl;
    margin: 0 auto;
    padding: 2rem 1rem;
  }
  
  .reading-compare-header {
    margin-bottom: 2rem;
  }
  
  .reading-compare-title {
    font-size: 2.25rem;
    font-weight: 800;
    color: #1e3a5f;
    margin-bottom: 0.75rem;
  }
  
  .reading-compare-subtitle {
    font-size: 1.25rem;
    color: #475569;
    line-height: 1.6;
  }
  
  .reading-compare-selector {
    background: white;
    border: 3px solid #1e3a5f;
    border-radius: 1rem;
    padding: 1.75rem;
    margin-bottom: 2rem;
  }
  
  .reading-compare-selector-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.25rem;
  }
  
  .reading-compare-selector-label {
    font-weight: 700;
    font-size: 1.125rem;
    color: #1e3a5f;
  }
  
  .reading-compare-clear-btn {
    background: #dc2626;
    color: white;
    border: none;
    border-radius: 0.5rem;
    padding: 0.75rem 1.25rem;
    font-size: 1rem;
    font-weight: 700;
    cursor: pointer;
  }
  
  .reading-compare-candidate-list {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }
  
  .reading-compare-candidate-btn {
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    padding: 1.5rem;
    background: white;
    border: 3px solid #e2e8f0;
    border-radius: 0.75rem;
    cursor: pointer;
    transition: all 0.2s;
    text-align: left;
    width: 100%;
  }
  
  .reading-compare-candidate-btn:hover {
    border-color: #1e3a5f;
  }
  
  .reading-compare-candidate-btn.selected {
    background: #ecfeff;
    border-color: #0891b2;
    border-width: 4px;
  }
  
  .reading-compare-candidate-name {
    font-size: 1.35rem;
    font-weight: 700;
    color: #0f172a;
    line-height: 1.2;
  }
  
  .reading-compare-candidate-party {
    font-size: 1rem;
    color: #64748b;
    margin-top: 0.5rem;
  }
  
  .reading-compare-hint {
    margin-top: 1.25rem;
    font-size: 1.125rem;
    color: #475569;
    line-height: 1.5;
  }
  
  .reading-compare-container {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
  }
  
  .reading-compare-section {
    background: white;
    border: 3px solid #1e3a5f;
    border-radius: 1rem;
    padding: 1.5rem;
  }
  
  .reading-compare-section-title {
    font-size: 1.5rem;
    font-weight: 800;
    color: #1e3a5f;
    margin-bottom: 1rem;
  }
  
  .reading-compare-empty {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 3rem;
    background: #f8fafc;
    border: 3px dashed #cbd5e1;
    border-radius: 1rem;
    color: #64748b;
  }
  
  .reading-compare-empty-icon {
    font-size: 3.5rem;
    margin-bottom: 1.25rem;
  }
  
  .reading-compare-empty-text {
    font-size: 1.25rem;
  }
  
  .reading-compare-summary {
    background: #f8fafc;
    border: 3px solid #1e3a5f;
    border-radius: 1rem;
    padding: 1.5rem;
    margin-bottom: 2rem;
  }
  
  .reading-compare-summary-title {
    font-size: 1.5rem;
    font-weight: 800;
    color: #1e3a5f;
    margin-bottom: 1.25rem;
  }
  
  .reading-compare-summary-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem;
    background: white;
    border: 2px solid #e2e8f0;
    border-radius: 0.5rem;
    margin-bottom: 0.75rem;
  }
  
  .reading-compare-summary-name {
    font-size: 1.25rem;
    font-weight: 700;
    color: #0f172a;
  }
  
  .reading-compare-summary-score {
    font-size: 1.75rem;
    font-weight: 800;
    color: #0891b2;
  }
  

  /* Responsive */
  @media (max-width: 768px) {
    .dashboard-compare-candidate-grid {
      grid-template-columns: 1fr;
    }
    
    .express-compare-candidate-grid {
      grid-template-columns: 1fr;
    }
  }
</style>

<script define:vars={{ candidates, scoresByCandidate, pillars, analysisByCandidate, proposals }}>
  const minSelection = 2;
  const maxSelection = 4;
  
  // Helper functions
  function getCandidateName(candidate) {
    const name = candidate?.candidate_name;
    if (name && name !== 'Por determinar' && name !== 'no_especificado') {
      return name;
    }
    return candidate?.party_name || 'N/A';
  }
  
  function getRiskLevel(candidateId) {
    if (!analysisByCandidate) return 'BAJO';
    const analysis = analysisByCandidate[candidateId];
    return analysis?.risk_level || 'BAJO';
  }
  
  function getRiskColor(risk) {
    if (risk === 'BAJO') return 'green';
    if (risk === 'MEDIO') return 'amber';
    return 'red';
  }
  
  function getRiskEmoji(risk) {
    if (risk === 'BAJO') return 'üü¢';
    if (risk === 'MEDIO') return 'üü†';
    return 'üî¥';
  }
  
  // Helper functions for penalties, bonuses, flags, etc.
  function getTotalPenalties(score) {
    return Math.abs(score.overall.total_penalties_applied || 0);
  }
  
  function getFiscalPenalty(score) {
    return Math.abs(score.fiscal_analysis.total_penalty || 0);
  }
  
  function getOmissionPenalty(score) {
    const oa = score.omission_analysis;
    if (!oa) return 0;
    return Math.abs((oa.urgency_penalty || 0) + (oa.pillar_penalty || 0));
  }
  
  function getViabilityPenalty(score) {
    return (score.pillar_scores || []).reduce((sum, ps) => {
      return sum + Math.abs(ps.viability_penalty || 0);
    }, 0);
  }
  
  function getTotalBonuses(score) {
    return (score.pillar_scores || []).reduce((sum, ps) => {
      return sum + (ps.bonus_multiple || 0) + (ps.bonus_quality || 0) + (ps.bonus_funding || 0);
    }, 0);
  }
  
  function getBonusesByType(score) {
    return (score.pillar_scores || []).reduce((acc, ps) => {
      acc.multiple += ps.bonus_multiple || 0;
      acc.quality += ps.bonus_quality || 0;
      acc.funding += ps.bonus_funding || 0;
      return acc;
    }, { multiple: 0, quality: 0, funding: 0 });
  }
  
  function getUrgencyCoverage(score) {
    const oa = score.omission_analysis;
    if (!oa?.urgency_coverage) return { security: false, ccss: false, employment: false, crime: false };
    return {
      security: oa.urgency_coverage.security_operations?.covered || false,
      ccss: oa.urgency_coverage.ccss_crisis?.covered || false,
      employment: oa.urgency_coverage.formal_employment?.covered || false,
      crime: oa.urgency_coverage.organized_crime?.covered || false,
    };
  }
  
  function getFlagLabel(key, category, flagData) {
    const labelMaps = {
      current_proposals: {
        violates_separation_powers: 'Viola Separaci√≥n de Poderes',
        violates_fundamental_rights: 'Viola Derechos Fundamentales',
        violates_constitutional_guarantees: 'Viola Garant√≠as Constitucionales',
        violates_constitutional_procedures: 'Viola Procedimientos Constitucionales',
      },
      dictatorial_patterns: {
        cuba_similarity: 'Similitudes con Modelo Cubano',
        venezuela_similarity: 'Similitudes con Modelo Venezolano',
      },
      power_negotiation_requirements: {
        requires_assembly_approval: 'Requiere Aprobaci√≥n de la Asamblea',
        requires_constitutional_reform: 'Requiere Reforma Constitucional',
        requires_judicial_review: 'Requiere Revisi√≥n Judicial',
        requires_regulatory_changes: 'Requiere Cambios Regulatorios',
      },
      historical: {
        anti_democratic_behavior: 'Comportamiento Anti-Democr√°tico',
        human_rights_violations: 'Violaciones de Derechos Humanos',
        corruption_convictions: 'Corrupci√≥n Verificada',
      },
      contradictions: {
        historical_current_contradiction: 'Contradicci√≥n Hist√≥rico-Actual',
        corruption_transparency_concern: 'Preocupaci√≥n Corrupci√≥n-Transparencia',
      },
    };
    
    if (flagData?.description) {
      return flagData.description;
    }
    
    if (labelMaps[category] && labelMaps[category][key]) {
      return labelMaps[category][key];
    }
    
    return key
      .split('_')
      .map(word => word.charAt(0).toUpperCase() + word.slice(1))
      .join(' ');
  }
  
  function getActiveFlags(score) {
    const flags = score.informative_flags;
    if (!flags) return [];
    
    const active = [];
    if (flags.current_proposals) {
      Object.entries(flags.current_proposals).forEach(([key, val]) => {
        if (val?.active) {
          active.push({ 
            category: 'Propuestas Actuales', 
            label: getFlagLabel(key, 'current_proposals', val),
            key: key
          });
        }
      });
    }
    if (flags.dictatorial_patterns) {
      Object.entries(flags.dictatorial_patterns).forEach(([key, val]) => {
        if (val?.active) {
          active.push({ 
            category: 'Similitudes Hist√≥ricas', 
            label: getFlagLabel(key, 'dictatorial_patterns', val),
            key: key
          });
        }
      });
    }
    if (flags.power_negotiation_requirements) {
      Object.entries(flags.power_negotiation_requirements).forEach(([key, val]) => {
        if (val?.active) {
          active.push({ 
            category: 'Negociaci√≥n de Poder', 
            label: getFlagLabel(key, 'power_negotiation_requirements', val),
            key: key
          });
        }
      });
    }
    if (flags.historical) {
      Object.entries(flags.historical).forEach(([key, val]) => {
        if (val?.active) {
          active.push({ 
            category: 'Evidencia Hist√≥rica', 
            label: getFlagLabel(key, 'historical', val),
            key: key
          });
        }
      });
    }
    if (flags.contradictions) {
      Object.entries(flags.contradictions).forEach(([key, val]) => {
        if (val?.active) {
          active.push({ 
            category: 'Contradicciones', 
            label: getFlagLabel(key, 'contradictions', val),
            key: key
          });
        }
      });
    }
    return active;
  }
  
  // Dashboard Mode Logic
  const dashboardSelected = new Set();
  const dashboardClearBtn = document.getElementById('dashboard-clear-btn');
  const dashboardHint = document.getElementById('dashboard-selection-hint');
  const dashboardContainer = document.getElementById('dashboard-comparison-container');
  const dashboardEmpty = document.getElementById('dashboard-empty-state');
  const dashboardSummary = document.getElementById('dashboard-comparative-summary');
  const dashboardPenalties = document.getElementById('dashboard-penalties-content');
  const dashboardBonuses = document.getElementById('dashboard-bonuses-content');
  const dashboardFlags = document.getElementById('dashboard-flags-content');
  const dashboardUrgency = document.getElementById('dashboard-urgency-content');
  
  // Event delegation for dashboard buttons
  document.addEventListener('click', (e) => {
    const btn = e.target.closest('.dashboard-compare-candidate-btn');
    if (!btn) return;
    
    const id = btn.getAttribute('data-candidate-id');
    if (!id) return;
    
    if (dashboardSelected.has(id)) {
      dashboardSelected.delete(id);
      btn.classList.remove('selected');
    } else if (dashboardSelected.size < maxSelection) {
      dashboardSelected.add(id);
      btn.classList.add('selected');
    }
    
    updateDashboardUI();
  });
  
  dashboardClearBtn?.addEventListener('click', () => {
    dashboardSelected.clear();
    document.querySelectorAll('.dashboard-compare-candidate-btn').forEach(btn => btn.classList.remove('selected'));
    updateDashboardUI();
  });
  
  function updateDashboardUI() {
    const count = dashboardSelected.size;
    dashboardClearBtn?.classList.toggle('hidden', count === 0);
    
    if (count >= minSelection) {
      dashboardContainer?.classList.remove('hidden');
      dashboardEmpty?.classList.add('hidden');
      renderDashboardComparison();
    } else {
      dashboardContainer?.classList.add('hidden');
      dashboardEmpty?.classList.remove('hidden');
    }
  }
  
  function renderDashboardComparison() {
    
    const selected = Array.from(dashboardSelected);
    console.log('Dashboard: Rendering comparison for', selected.length, 'candidates:', selected);
    
    if (!candidates || !scoresByCandidate || !pillars) {
      console.error('Dashboard: Missing data', { 
        candidates: !!candidates, 
        scoresByCandidate: !!scoresByCandidate, 
        pillars: !!pillars 
      });
      return;
    }
    
    const candidateData = selected.map(id => {
      const candidate = candidates.find(c => c.candidate_id === id);
      const score = scoresByCandidate[id];
      const analysis = analysisByCandidate[id];
      if (!candidate || !score) {
        console.warn('Dashboard: Missing data for candidate', id, { candidate: !!candidate, score: !!score });
        return null;
      }
      return { candidate, score, analysis };
    }).filter(Boolean);
    
    if (candidateData.length === 0) {
      console.warn('Dashboard: No valid candidate data after filtering');
      return;
    }
    
    console.log('Dashboard: Rendering', candidateData.length, 'candidates');
    
    // Render Comparative Summary
    if (dashboardSummary) {
      dashboardSummary.innerHTML = `
        <h3 class="dashboard-compare-section-title">üìä Resumen Comparativo</h3>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
          ${candidateData.map(({ candidate, score, analysis }) => {
            const riskLevel = getRiskLevel(candidate.candidate_id);
            const riskColor = getRiskColor(riskLevel);
            const riskEmoji = getRiskEmoji(riskLevel);
            const totalPenalties = getTotalPenalties(score);
            const totalBonuses = getTotalBonuses(score);
            const weightedPercent = Math.round(score.overall.weighted_sum * 100);
            const urgencyCoverage = getUrgencyCoverage(score);
            const coverageCount = Object.values(urgencyCoverage).filter(Boolean).length;
            
            return `
              <div style="background: white; border: 2px solid #e2e8f0; border-radius: 0.75rem; padding: 1rem;">
                <div style="font-weight: 700; color: #0f172a; margin-bottom: 0.5rem;">${getCandidateName(candidate)}</div>
                <div style="font-size: 0.875rem; color: #64748b; margin-bottom: 0.75rem;">${candidate.party_name}</div>
                <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                  <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span style="font-size: 0.875rem; color: #64748b;">Puntaje:</span>
                    <span style="font-size: 1.5rem; font-weight: 700; color: #0891b2;">${weightedPercent}%</span>
                  </div>
                  <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span style="font-size: 0.875rem; color: #64748b;">Riesgo:</span>
                    <span style="font-size: 0.875rem; padding: 0.25rem 0.5rem; border-radius: 0.375rem; font-weight: 600; background: ${riskColor === 'green' ? '#dcfce7' : riskColor === 'amber' ? '#fef3c7' : '#fee2e2'}; color: ${riskColor === 'green' ? '#166534' : riskColor === 'amber' ? '#92400e' : '#991b1b'};">${riskEmoji} ${riskLevel}</span>
                  </div>
                  ${totalPenalties > 0 ? `
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                      <span style="font-size: 0.875rem; color: #64748b;">Penalizaciones:</span>
                      <span style="font-size: 0.875rem; font-weight: 700; color: #dc2626;">-${Math.round(totalPenalties)}</span>
                    </div>
                  ` : ''}
                  ${totalBonuses > 0 ? `
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                      <span style="font-size: 0.875rem; color: #64748b;">Bonos:</span>
                      <span style="font-size: 0.875rem; font-weight: 700; color: #059669;">+${totalBonuses.toFixed(1)}</span>
                    </div>
                  ` : ''}
                  <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span style="font-size: 0.875rem; color: #64748b;">Urgencias:</span>
                    <span style="font-size: 0.875rem; font-weight: 600; color: ${coverageCount === 4 ? '#059669' : coverageCount >= 2 ? '#d97706' : '#dc2626'};">${coverageCount}/4</span>
                  </div>
                </div>
              </div>
            `;
          }).join('')}
        </div>
      `;
    }
    
    // Render Penalties Comparison
    if (dashboardPenalties) {
      dashboardPenalties.innerHTML = `
        <div style="overflow-x: auto;">
          <table style="width: 100%; font-size: 0.875rem; border-collapse: collapse;">
            <thead>
              <tr style="border-bottom: 1px solid #e2e8f0;">
                <th style="text-align: left; padding: 0.5rem 0.75rem; font-weight: 600; color: #475569;">Tipo</th>
                ${candidateData.map(({ candidate }) => `
                  <th style="text-align: center; padding: 0.5rem 0.75rem; font-weight: 600; color: #475569;">${getCandidateName(candidate)}</th>
                `).join('')}
              </tr>
            </thead>
            <tbody>
              <tr style="border-bottom: 1px solid #f1f5f9;">
                <td style="padding: 0.5rem 0.75rem; color: #64748b;">üí∞ Penalizaci√≥n Fiscal</td>
                ${candidateData.map(({ score }) => {
                  const fiscal = getFiscalPenalty(score);
                  return `<td style="text-align: center; padding: 0.5rem 0.75rem;">${fiscal > 0 ? `<span style="color: #dc2626; font-weight: 700;">-${Math.round(fiscal)}</span>` : '<span style="color: #94a3b8;">0</span>'}</td>`;
                }).join('')}
              </tr>
              <tr style="border-bottom: 1px solid #f1f5f9;">
                <td style="padding: 0.5rem 0.75rem; color: #64748b;">üö® Penalizaci√≥n por Omisi√≥n</td>
                ${candidateData.map(({ score }) => {
                  const omission = getOmissionPenalty(score);
                  return `<td style="text-align: center; padding: 0.5rem 0.75rem;">${omission > 0 ? `<span style="color: #dc2626; font-weight: 700;">-${Math.round(omission)}</span>` : '<span style="color: #94a3b8;">0</span>'}</td>`;
                }).join('')}
              </tr>
              <tr style="border-bottom: 1px solid #f1f5f9;">
                <td style="padding: 0.5rem 0.75rem; color: #64748b;">‚öñÔ∏è Penalizaci√≥n por Viabilidad</td>
                ${candidateData.map(({ score }) => {
                  const viability = getViabilityPenalty(score);
                  return `<td style="text-align: center; padding: 0.5rem 0.75rem;">${viability > 0 ? `<span style="color: #dc2626; font-weight: 700;">-${Math.round(viability)}</span>` : '<span style="color: #94a3b8;">0</span>'}</td>`;
                }).join('')}
              </tr>
              <tr style="background: #f8fafc; font-weight: 600;">
                <td style="padding: 0.5rem 0.75rem; color: #0f172a;">Total Penalizaciones</td>
                ${candidateData.map(({ score }) => {
                  const total = getTotalPenalties(score);
                  return `<td style="text-align: center; padding: 0.5rem 0.75rem; color: #dc2626;">${total > 0 ? `-${Math.round(total)}` : '0'}</td>`;
                }).join('')}
              </tr>
            </tbody>
          </table>
        </div>
      `;
    }
    
    // Render Bonuses Comparison
    if (dashboardBonuses) {
      dashboardBonuses.innerHTML = `
        <div style="overflow-x: auto;">
          <table style="width: 100%; font-size: 0.875rem; border-collapse: collapse;">
            <thead>
              <tr style="border-bottom: 1px solid #e2e8f0;">
                <th style="text-align: left; padding: 0.5rem 0.75rem; font-weight: 600; color: #475569;">Tipo de Bono</th>
                ${candidateData.map(({ candidate }) => `
                  <th style="text-align: center; padding: 0.5rem 0.75rem; font-weight: 600; color: #475569;">${getCandidateName(candidate)}</th>
                `).join('')}
              </tr>
            </thead>
            <tbody>
              <tr style="border-bottom: 1px solid #f1f5f9;">
                <td style="padding: 0.5rem 0.75rem; color: #64748b;">üéØ M√∫ltiples Propuestas (3+)</td>
                ${candidateData.map(({ score }) => {
                  const bonuses = getBonusesByType(score);
                  return `<td style="text-align: center; padding: 0.5rem 0.75rem;">${bonuses.multiple > 0 ? `<span style="color: #059669; font-weight: 700;">+${bonuses.multiple.toFixed(1)}</span>` : '<span style="color: #94a3b8;">0</span>'}</td>`;
                }).join('')}
              </tr>
              <tr style="border-bottom: 1px solid #f1f5f9;">
                <td style="padding: 0.5rem 0.75rem; color: #64748b;">‚≠ê Calidad (Propuestas Completas 4/4)</td>
                ${candidateData.map(({ score }) => {
                  const bonuses = getBonusesByType(score);
                  return `<td style="text-align: center; padding: 0.5rem 0.75rem;">${bonuses.quality > 0 ? `<span style="color: #059669; font-weight: 700;">+${bonuses.quality.toFixed(1)}</span>` : '<span style="color: #94a3b8;">0</span>'}</td>`;
                }).join('')}
              </tr>
              <tr style="border-bottom: 1px solid #f1f5f9;">
                <td style="padding: 0.5rem 0.75rem; color: #64748b;">üí∞ Financiamiento</td>
                ${candidateData.map(({ score }) => {
                  const bonuses = getBonusesByType(score);
                  return `<td style="text-align: center; padding: 0.5rem 0.75rem;">${bonuses.funding > 0 ? `<span style="color: #059669; font-weight: 700;">+${bonuses.funding.toFixed(1)}</span>` : '<span style="color: #94a3b8;">0</span>'}</td>`;
                }).join('')}
              </tr>
              <tr style="background: #f8fafc; font-weight: 600;">
                <td style="padding: 0.5rem 0.75rem; color: #0f172a;">Total Bonos</td>
                ${candidateData.map(({ score }) => {
                  const total = getTotalBonuses(score);
                  return `<td style="text-align: center; padding: 0.5rem 0.75rem; color: #059669;">${total > 0 ? `+${total.toFixed(1)}` : '0'}</td>`;
                }).join('')}
              </tr>
            </tbody>
          </table>
        </div>
      `;
    }
    
    // Render Flags Comparison
    if (dashboardFlags) {
      const allFlagsMap = new Map();
      candidateData.forEach(({ score }) => {
        getActiveFlags(score).forEach(flag => {
          if (!allFlagsMap.has(flag.key)) {
            allFlagsMap.set(flag.key, { label: flag.label, category: flag.category });
          }
        });
      });
      
      if (allFlagsMap.size > 0) {
        const flagsByCategory = {};
        allFlagsMap.forEach((flag, key) => {
          if (!flagsByCategory[flag.category]) {
            flagsByCategory[flag.category] = [];
          }
          flagsByCategory[flag.category].push({ key, ...flag });
        });
        
        dashboardFlags.innerHTML = `
          <div style="display: flex; flex-direction: column; gap: 1rem;">
            ${Object.entries(flagsByCategory).map(([category, flags]) => `
              <div>
                <h4 style="font-weight: 600; color: #475569; margin-bottom: 0.5rem; font-size: 0.875rem;">${category}</h4>
                <div style="overflow-x: auto;">
                  <table style="width: 100%; font-size: 0.875rem; border-collapse: collapse;">
                    <thead>
                      <tr style="border-bottom: 1px solid #e2e8f0;">
                        <th style="text-align: left; padding: 0.5rem 0.75rem; font-weight: 600; color: #475569;">Flag</th>
                        ${candidateData.map(({ candidate }) => `
                          <th style="text-align: center; padding: 0.5rem 0.75rem; font-weight: 600; color: #475569;">${getCandidateName(candidate)}</th>
                        `).join('')}
                      </tr>
                    </thead>
                    <tbody>
                      ${flags.map(flag => `
                        <tr style="border-bottom: 1px solid #f1f5f9;">
                          <td style="padding: 0.5rem 0.75rem; color: #64748b;">${flag.label}</td>
                          ${candidateData.map(({ score }) => {
                            const candidateFlags = getActiveFlags(score);
                            const hasFlag = candidateFlags.some(f => f.key === flag.key);
                            return `<td style="text-align: center; padding: 0.5rem 0.75rem;">${hasFlag ? '<span style="color: #2563eb; font-weight: 700;">‚úì</span>' : '<span style="color: #cbd5e1;">‚Äî</span>'}</td>`;
                          }).join('')}
                        </tr>
                      `).join('')}
                    </tbody>
                  </table>
                </div>
              </div>
            `).join('')}
          </div>
        `;
      } else {
        dashboardFlags.innerHTML = '<p style="color: #64748b; font-size: 0.875rem;">Ninguno de los candidatos seleccionados tiene informaci√≥n adicional activa.</p>';
      }
    }
    
    // Render Urgency Coverage Comparison
    if (dashboardUrgency) {
      dashboardUrgency.innerHTML = `
        <div style="overflow-x: auto;">
          <table style="width: 100%; font-size: 0.875rem; border-collapse: collapse;">
            <thead>
              <tr style="border-bottom: 1px solid #e2e8f0;">
                <th style="text-align: left; padding: 0.5rem 0.75rem; font-weight: 600; color: #475569;">Urgencia Nacional</th>
                ${candidateData.map(({ candidate }) => `
                  <th style="text-align: center; padding: 0.5rem 0.75rem; font-weight: 600; color: #475569;">${getCandidateName(candidate)}</th>
                `).join('')}
              </tr>
            </thead>
            <tbody>
              <tr style="border-bottom: 1px solid #f1f5f9;">
                <td style="padding: 0.5rem 0.75rem; color: #64748b;">üõ°Ô∏è Operaciones de Seguridad</td>
                ${candidateData.map(({ score }) => {
                  const coverage = getUrgencyCoverage(score);
                  return `<td style="text-align: center; padding: 0.5rem 0.75rem;">${coverage.security ? '<span style="color: #059669; font-weight: 700;">‚úì Cubre</span>' : '<span style="color: #dc2626; font-weight: 700;">‚úó No cubre</span>'}</td>`;
                }).join('')}
              </tr>
              <tr style="border-bottom: 1px solid #f1f5f9;">
                <td style="padding: 0.5rem 0.75rem; color: #64748b;">üè• Crisis CCSS</td>
                ${candidateData.map(({ score }) => {
                  const coverage = getUrgencyCoverage(score);
                  return `<td style="text-align: center; padding: 0.5rem 0.75rem;">${coverage.ccss ? '<span style="color: #059669; font-weight: 700;">‚úì Cubre</span>' : '<span style="color: #dc2626; font-weight: 700;">‚úó No cubre</span>'}</td>`;
                }).join('')}
              </tr>
              <tr style="border-bottom: 1px solid #f1f5f9;">
                <td style="padding: 0.5rem 0.75rem; color: #64748b;">üíº Empleo Formal</td>
                ${candidateData.map(({ score }) => {
                  const coverage = getUrgencyCoverage(score);
                  return `<td style="text-align: center; padding: 0.5rem 0.75rem;">${coverage.employment ? '<span style="color: #059669; font-weight: 700;">‚úì Cubre</span>' : '<span style="color: #dc2626; font-weight: 700;">‚úó No cubre</span>'}</td>`;
                }).join('')}
              </tr>
              <tr style="border-bottom: 1px solid #f1f5f9;">
                <td style="padding: 0.5rem 0.75rem; color: #64748b;">üö® Crimen Organizado</td>
                ${candidateData.map(({ score }) => {
                  const coverage = getUrgencyCoverage(score);
                  return `<td style="text-align: center; padding: 0.5rem 0.75rem;">${coverage.crime ? '<span style="color: #059669; font-weight: 700;">‚úì Cubre</span>' : '<span style="color: #dc2626; font-weight: 700;">‚úó No cubre</span>'}</td>`;
                }).join('')}
              </tr>
            </tbody>
          </table>
        </div>
      `;
    }
  }
  
  // Express Mode Logic
  const expressSelected = new Set();
  const expressClearBtn = document.getElementById('express-clear-btn');
  const expressHint = document.getElementById('express-selection-hint');
  const expressContainer = document.getElementById('express-comparison-container');
  const expressEmpty = document.getElementById('express-empty-state');
  const expressSummary = document.getElementById('express-comparative-summary');
  const expressPenalties = document.getElementById('express-penalties-content');
  const expressBonuses = document.getElementById('express-bonuses-content');
  const expressFlags = document.getElementById('express-flags-content');
  const expressUrgency = document.getElementById('express-urgency-content');
  
  document.addEventListener('click', (e) => {
    const btn = e.target.closest('.express-compare-candidate-btn');
    if (!btn) return;
    
    const id = btn.getAttribute('data-candidate-id');
    if (!id) return;
    
    if (expressSelected.has(id)) {
      expressSelected.delete(id);
      btn.classList.remove('selected');
    } else if (expressSelected.size < maxSelection) {
      expressSelected.add(id);
      btn.classList.add('selected');
    }
    
    updateExpressUI();
  });
  
  expressClearBtn?.addEventListener('click', () => {
    expressSelected.clear();
    document.querySelectorAll('.express-compare-candidate-btn').forEach(btn => btn.classList.remove('selected'));
    updateExpressUI();
  });
  
  function updateExpressUI() {
    const count = expressSelected.size;
    expressClearBtn?.classList.toggle('hidden', count === 0);
    
    if (count >= minSelection) {
      expressContainer?.classList.remove('hidden');
      expressEmpty?.classList.add('hidden');
      renderExpressComparison();
    } else {
      expressContainer?.classList.add('hidden');
      expressEmpty?.classList.remove('hidden');
    }
  }
  
  function renderExpressComparison() {
    
    const selected = Array.from(expressSelected);
    console.log('Express: Rendering comparison for', selected.length, 'candidates:', selected);
    
    if (!candidates || !scoresByCandidate || !pillars) {
      console.error('Express: Missing data');
      return;
    }
    
    const candidateData = selected.map(id => {
      const candidate = candidates.find(c => c.candidate_id === id);
      const score = scoresByCandidate[id];
      if (!candidate || !score) return null;
      return { candidate, score };
    }).filter(Boolean);
    
    if (candidateData.length === 0) {
      console.warn('Express: No valid candidate data');
      return;
    }
    
    // Render Comparative Summary
    if (expressSummary) {
      expressSummary.innerHTML = `
        <h3 class="express-compare-section-title">üìä Resumen</h3>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 0.75rem;">
          ${candidateData.map(({ candidate, score }) => {
            const riskLevel = getRiskLevel(candidate.candidate_id);
            const riskEmoji = getRiskEmoji(riskLevel);
            const totalPenalties = getTotalPenalties(score);
            const totalBonuses = getTotalBonuses(score);
            const weightedPercent = Math.round(score.overall.weighted_sum * 100);
            return `
              <div style="background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 0.5rem; padding: 0.75rem; text-align: center;">
                <div style="font-weight: 700; font-size: 0.85rem; color: #0f172a; margin-bottom: 0.25rem;">${getCandidateName(candidate)}</div>
                <div style="font-size: 1.25rem; font-weight: 700; color: #0891b2; margin-bottom: 0.5rem;">${weightedPercent}%</div>
                <div style="display: flex; flex-direction: column; gap: 0.25rem; font-size: 0.75rem;">
                  <div>${riskEmoji} ${riskLevel}</div>
                  ${totalPenalties > 0 ? `<div style="color: #dc2626;">-${Math.round(totalPenalties)}</div>` : ''}
                  ${totalBonuses > 0 ? `<div style="color: #059669;">+${totalBonuses.toFixed(1)}</div>` : ''}
                </div>
              </div>
            `;
          }).join('')}
        </div>
      `;
    }
    
    // Render Penalties Comparison
    if (expressPenalties) {
      expressPenalties.innerHTML = `
        <div style="overflow-x: auto;">
          <table style="width: 100%; font-size: 0.8rem; border-collapse: collapse;">
            <thead>
              <tr style="border-bottom: 1px solid #e2e8f0;">
                <th style="text-align: left; padding: 0.5rem; font-weight: 600; color: #475569;">Tipo</th>
                ${candidateData.map(({ candidate }) => `
                  <th style="text-align: center; padding: 0.5rem; font-weight: 600; color: #475569; font-size: 0.75rem;">${getCandidateName(candidate)}</th>
                `).join('')}
              </tr>
            </thead>
            <tbody>
              <tr style="border-bottom: 1px solid #f1f5f9;">
                <td style="padding: 0.5rem; color: #64748b; font-size: 0.75rem;">üí∞ Fiscal</td>
                ${candidateData.map(({ score }) => {
                  const fiscal = getFiscalPenalty(score);
                  return `<td style="text-align: center; padding: 0.5rem; font-size: 0.75rem;">${fiscal > 0 ? `<span style="color: #dc2626; font-weight: 700;">-${Math.round(fiscal)}</span>` : '<span style="color: #94a3b8;">0</span>'}</td>`;
                }).join('')}
              </tr>
              <tr style="border-bottom: 1px solid #f1f5f9;">
                <td style="padding: 0.5rem; color: #64748b; font-size: 0.75rem;">üö® Omisi√≥n</td>
                ${candidateData.map(({ score }) => {
                  const omission = getOmissionPenalty(score);
                  return `<td style="text-align: center; padding: 0.5rem; font-size: 0.75rem;">${omission > 0 ? `<span style="color: #dc2626; font-weight: 700;">-${Math.round(omission)}</span>` : '<span style="color: #94a3b8;">0</span>'}</td>`;
                }).join('')}
              </tr>
              <tr style="border-bottom: 1px solid #f1f5f9;">
                <td style="padding: 0.5rem; color: #64748b; font-size: 0.75rem;">‚öñÔ∏è Viabilidad</td>
                ${candidateData.map(({ score }) => {
                  const viability = getViabilityPenalty(score);
                  return `<td style="text-align: center; padding: 0.5rem; font-size: 0.75rem;">${viability > 0 ? `<span style="color: #dc2626; font-weight: 700;">-${Math.round(viability)}</span>` : '<span style="color: #94a3b8;">0</span>'}</td>`;
                }).join('')}
              </tr>
              <tr style="background: #f8fafc; font-weight: 600;">
                <td style="padding: 0.5rem; color: #0f172a; font-size: 0.75rem;">Total</td>
                ${candidateData.map(({ score }) => {
                  const total = getTotalPenalties(score);
                  return `<td style="text-align: center; padding: 0.5rem; color: #dc2626; font-size: 0.75rem;">${total > 0 ? `-${Math.round(total)}` : '0'}</td>`;
                }).join('')}
              </tr>
            </tbody>
          </table>
        </div>
      `;
    }
    
    // Render Bonuses Comparison
    if (expressBonuses) {
      expressBonuses.innerHTML = `
        <div style="overflow-x: auto;">
          <table style="width: 100%; font-size: 0.8rem; border-collapse: collapse;">
            <thead>
              <tr style="border-bottom: 1px solid #e2e8f0;">
                <th style="text-align: left; padding: 0.5rem; font-weight: 600; color: #475569;">Tipo</th>
                ${candidateData.map(({ candidate }) => `
                  <th style="text-align: center; padding: 0.5rem; font-weight: 600; color: #475569; font-size: 0.75rem;">${getCandidateName(candidate)}</th>
                `).join('')}
              </tr>
            </thead>
            <tbody>
              <tr style="border-bottom: 1px solid #f1f5f9;">
                <td style="padding: 0.5rem; color: #64748b; font-size: 0.75rem;">üéØ M√∫ltiples</td>
                ${candidateData.map(({ score }) => {
                  const bonuses = getBonusesByType(score);
                  return `<td style="text-align: center; padding: 0.5rem; font-size: 0.75rem;">${bonuses.multiple > 0 ? `<span style="color: #059669; font-weight: 700;">+${bonuses.multiple.toFixed(1)}</span>` : '<span style="color: #94a3b8;">0</span>'}</td>`;
                }).join('')}
              </tr>
              <tr style="border-bottom: 1px solid #f1f5f9;">
                <td style="padding: 0.5rem; color: #64748b; font-size: 0.75rem;">‚≠ê Calidad</td>
                ${candidateData.map(({ score }) => {
                  const bonuses = getBonusesByType(score);
                  return `<td style="text-align: center; padding: 0.5rem; font-size: 0.75rem;">${bonuses.quality > 0 ? `<span style="color: #059669; font-weight: 700;">+${bonuses.quality.toFixed(1)}</span>` : '<span style="color: #94a3b8;">0</span>'}</td>`;
                }).join('')}
              </tr>
              <tr style="border-bottom: 1px solid #f1f5f9;">
                <td style="padding: 0.5rem; color: #64748b; font-size: 0.75rem;">üí∞ Financiamiento</td>
                ${candidateData.map(({ score }) => {
                  const bonuses = getBonusesByType(score);
                  return `<td style="text-align: center; padding: 0.5rem; font-size: 0.75rem;">${bonuses.funding > 0 ? `<span style="color: #059669; font-weight: 700;">+${bonuses.funding.toFixed(1)}</span>` : '<span style="color: #94a3b8;">0</span>'}</td>`;
                }).join('')}
              </tr>
              <tr style="background: #f8fafc; font-weight: 600;">
                <td style="padding: 0.5rem; color: #0f172a; font-size: 0.75rem;">Total</td>
                ${candidateData.map(({ score }) => {
                  const total = getTotalBonuses(score);
                  return `<td style="text-align: center; padding: 0.5rem; color: #059669; font-size: 0.75rem;">${total > 0 ? `+${total.toFixed(1)}` : '0'}</td>`;
                }).join('')}
              </tr>
            </tbody>
          </table>
        </div>
      `;
    }
    
    // Render Flags Comparison
    if (expressFlags) {
      const allFlagsMap = new Map();
      candidateData.forEach(({ score }) => {
        getActiveFlags(score).forEach(flag => {
          if (!allFlagsMap.has(flag.key)) {
            allFlagsMap.set(flag.key, { label: flag.label, category: flag.category });
          }
        });
      });
      
      if (allFlagsMap.size > 0) {
        const flagsByCategory = {};
        allFlagsMap.forEach((flag, key) => {
          if (!flagsByCategory[flag.category]) {
            flagsByCategory[flag.category] = [];
          }
          flagsByCategory[flag.category].push({ key, ...flag });
        });
        
        expressFlags.innerHTML = `
          <div style="display: flex; flex-direction: column; gap: 0.75rem;">
            ${Object.entries(flagsByCategory).map(([category, flags]) => `
              <div>
                <h4 style="font-weight: 600; color: #475569; margin-bottom: 0.5rem; font-size: 0.75rem;">${category}</h4>
                <div style="overflow-x: auto;">
                  <table style="width: 100%; font-size: 0.75rem; border-collapse: collapse;">
                    <thead>
                      <tr style="border-bottom: 1px solid #e2e8f0;">
                        <th style="text-align: left; padding: 0.5rem; font-weight: 600; color: #475569;">Flag</th>
                        ${candidateData.map(({ candidate }) => `
                          <th style="text-align: center; padding: 0.5rem; font-weight: 600; color: #475569;">${getCandidateName(candidate)}</th>
                        `).join('')}
                      </tr>
                    </thead>
                    <tbody>
                      ${flags.map(flag => `
                        <tr style="border-bottom: 1px solid #f1f5f9;">
                          <td style="padding: 0.5rem; color: #64748b; font-size: 0.7rem;">${flag.label}</td>
                          ${candidateData.map(({ score }) => {
                            const candidateFlags = getActiveFlags(score);
                            const hasFlag = candidateFlags.some(f => f.key === flag.key);
                            return `<td style="text-align: center; padding: 0.5rem;">${hasFlag ? '<span style="color: #2563eb; font-weight: 700;">‚úì</span>' : '<span style="color: #cbd5e1;">‚Äî</span>'}</td>`;
                          }).join('')}
                        </tr>
                      `).join('')}
                    </tbody>
                  </table>
                </div>
              </div>
            `).join('')}
          </div>
        `;
      } else {
        expressFlags.innerHTML = '<p style="color: #64748b; font-size: 0.75rem;">Sin informaci√≥n adicional.</p>';
      }
    }
    
    // Render Urgency Coverage Comparison
    if (expressUrgency) {
      expressUrgency.innerHTML = `
        <div style="overflow-x: auto;">
          <table style="width: 100%; font-size: 0.8rem; border-collapse: collapse;">
            <thead>
              <tr style="border-bottom: 1px solid #e2e8f0;">
                <th style="text-align: left; padding: 0.5rem; font-weight: 600; color: #475569;">Urgencia</th>
                ${candidateData.map(({ candidate }) => `
                  <th style="text-align: center; padding: 0.5rem; font-weight: 600; color: #475569; font-size: 0.75rem;">${getCandidateName(candidate)}</th>
                `).join('')}
              </tr>
            </thead>
            <tbody>
              <tr style="border-bottom: 1px solid #f1f5f9;">
                <td style="padding: 0.5rem; color: #64748b; font-size: 0.75rem;">üõ°Ô∏è Seguridad</td>
                ${candidateData.map(({ score }) => {
                  const coverage = getUrgencyCoverage(score);
                  return `<td style="text-align: center; padding: 0.5rem; font-size: 0.75rem;">${coverage.security ? '<span style="color: #059669; font-weight: 700;">‚úì</span>' : '<span style="color: #dc2626; font-weight: 700;">‚úó</span>'}</td>`;
                }).join('')}
              </tr>
              <tr style="border-bottom: 1px solid #f1f5f9;">
                <td style="padding: 0.5rem; color: #64748b; font-size: 0.75rem;">üè• CCSS</td>
                ${candidateData.map(({ score }) => {
                  const coverage = getUrgencyCoverage(score);
                  return `<td style="text-align: center; padding: 0.5rem; font-size: 0.75rem;">${coverage.ccss ? '<span style="color: #059669; font-weight: 700;">‚úì</span>' : '<span style="color: #dc2626; font-weight: 700;">‚úó</span>'}</td>`;
                }).join('')}
              </tr>
              <tr style="border-bottom: 1px solid #f1f5f9;">
                <td style="padding: 0.5rem; color: #64748b; font-size: 0.75rem;">üíº Empleo</td>
                ${candidateData.map(({ score }) => {
                  const coverage = getUrgencyCoverage(score);
                  return `<td style="text-align: center; padding: 0.5rem; font-size: 0.75rem;">${coverage.employment ? '<span style="color: #059669; font-weight: 700;">‚úì</span>' : '<span style="color: #dc2626; font-weight: 700;">‚úó</span>'}</td>`;
                }).join('')}
              </tr>
              <tr style="border-bottom: 1px solid #f1f5f9;">
                <td style="padding: 0.5rem; color: #64748b; font-size: 0.75rem;">üö® Crimen</td>
                ${candidateData.map(({ score }) => {
                  const coverage = getUrgencyCoverage(score);
                  return `<td style="text-align: center; padding: 0.5rem; font-size: 0.75rem;">${coverage.crime ? '<span style="color: #059669; font-weight: 700;">‚úì</span>' : '<span style="color: #dc2626; font-weight: 700;">‚úó</span>'}</td>`;
                }).join('')}
              </tr>
            </tbody>
          </table>
        </div>
      `;
    }
  }
  
  // Reading Mode Logic
  const readingSelected = new Set();
  const readingClearBtn = document.getElementById('reading-clear-btn');
  const readingHint = document.getElementById('reading-selection-hint');
  const readingContainer = document.getElementById('reading-comparison-container');
  const readingEmpty = document.getElementById('reading-empty-state');
  const readingSummary = document.getElementById('reading-comparative-summary');
  const readingPenalties = document.getElementById('reading-penalties-content');
  const readingBonuses = document.getElementById('reading-bonuses-content');
  const readingFlags = document.getElementById('reading-flags-content');
  const readingUrgency = document.getElementById('reading-urgency-content');
  
  document.addEventListener('click', (e) => {
    const btn = e.target.closest('.reading-compare-candidate-btn');
    if (!btn) return;
    
    const id = btn.getAttribute('data-candidate-id');
    if (!id) return;
    
    if (readingSelected.has(id)) {
      readingSelected.delete(id);
      btn.classList.remove('selected');
    } else if (readingSelected.size < maxSelection) {
      readingSelected.add(id);
      btn.classList.add('selected');
    }
    
    updateReadingUI();
  });
  
  readingClearBtn?.addEventListener('click', () => {
    readingSelected.clear();
    document.querySelectorAll('.reading-compare-candidate-btn').forEach(btn => btn.classList.remove('selected'));
    updateReadingUI();
  });
  
  function updateReadingUI() {
    const count = readingSelected.size;
    readingClearBtn?.classList.toggle('hidden', count === 0);
    
    if (count >= minSelection) {
      readingContainer?.classList.remove('hidden');
      readingEmpty?.classList.add('hidden');
      renderReadingComparison();
    } else {
      readingContainer?.classList.add('hidden');
      readingEmpty?.classList.remove('hidden');
    }
  }
  
  function renderReadingComparison() {
    
    const selected = Array.from(readingSelected);
    console.log('Reading: Rendering comparison for', selected.length, 'candidates:', selected);
    
    if (!candidates || !scoresByCandidate || !pillars) {
      console.error('Reading: Missing data');
      return;
    }
    
    const candidateData = selected.map(id => {
      const candidate = candidates.find(c => c.candidate_id === id);
      const score = scoresByCandidate[id];
      if (!candidate || !score) return null;
      return { candidate, score };
    }).filter(Boolean);
    
    if (candidateData.length === 0) {
      console.warn('Reading: No valid candidate data');
      return;
    }
    
    // Render Comparative Summary
    if (readingSummary) {
      readingSummary.innerHTML = `
        <h3 class="reading-compare-section-title">üìä Resumen Comparativo</h3>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.25rem;">
          ${candidateData.map(({ candidate, score }) => {
            const riskLevel = getRiskLevel(candidate.candidate_id);
            const riskEmoji = getRiskEmoji(riskLevel);
            const totalPenalties = getTotalPenalties(score);
            const totalBonuses = getTotalBonuses(score);
            const weightedPercent = Math.round(score.overall.weighted_sum * 100);
            const urgencyCoverage = getUrgencyCoverage(score);
            const coverageCount = Object.values(urgencyCoverage).filter(Boolean).length;
            return `
              <div style="background: white; border: 3px solid #e2e8f0; border-radius: 0.75rem; padding: 1.25rem;">
                <div style="font-weight: 700; font-size: 1.25rem; color: #0f172a; margin-bottom: 0.5rem;">${getCandidateName(candidate)}</div>
                <div style="font-size: 1rem; color: #64748b; margin-bottom: 1rem;">${candidate.party_name}</div>
                <div style="text-align: center; margin-bottom: 1rem;">
                  <div style="font-size: 2rem; font-weight: 800; color: #0891b2;">${weightedPercent}%</div>
                  <div style="font-size: 0.875rem; color: #64748b;">Puntaje General</div>
                </div>
                <div style="display: flex; flex-direction: column; gap: 0.75rem; font-size: 1rem;">
                  <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span style="color: #475569;">Riesgo Fiscal:</span>
                    <span style="font-weight: 700; font-size: 1.125rem;">${riskEmoji} ${riskLevel}</span>
                  </div>
                  ${totalPenalties > 0 ? `
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                      <span style="color: #475569;">Penalizaciones:</span>
                      <span style="font-weight: 700; color: #dc2626; font-size: 1.125rem;">-${Math.round(totalPenalties)}</span>
                    </div>
                  ` : ''}
                  ${totalBonuses > 0 ? `
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                      <span style="color: #475569;">Bonos:</span>
                      <span style="font-weight: 700; color: #059669; font-size: 1.125rem;">+${totalBonuses.toFixed(1)}</span>
                    </div>
                  ` : ''}
                  <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span style="color: #475569;">Urgencias Cubiertas:</span>
                    <span style="font-weight: 700; color: ${coverageCount === 4 ? '#059669' : coverageCount >= 2 ? '#d97706' : '#dc2626'}; font-size: 1.125rem;">${coverageCount}/4</span>
                  </div>
                </div>
              </div>
            `;
          }).join('')}
        </div>
      `;
    }
    
    // Render Penalties Comparison
    if (readingPenalties) {
      readingPenalties.innerHTML = `
        <div style="overflow-x: auto;">
          <table style="width: 100%; font-size: 1rem; border-collapse: collapse;">
            <thead>
              <tr style="border-bottom: 2px solid #1e3a5f;">
                <th style="text-align: left; padding: 0.75rem; font-weight: 700; color: #1e3a5f; font-size: 1.125rem;">Tipo</th>
                ${candidateData.map(({ candidate }) => `
                  <th style="text-align: center; padding: 0.75rem; font-weight: 700; color: #1e3a5f; font-size: 1.125rem;">${getCandidateName(candidate)}</th>
                `).join('')}
              </tr>
            </thead>
            <tbody>
              <tr style="border-bottom: 1px solid #e2e8f0;">
                <td style="padding: 0.75rem; color: #475569; font-size: 1rem;">üí∞ Penalizaci√≥n Fiscal</td>
                ${candidateData.map(({ score }) => {
                  const fiscal = getFiscalPenalty(score);
                  return `<td style="text-align: center; padding: 0.75rem; font-size: 1rem;">${fiscal > 0 ? `<span style="color: #dc2626; font-weight: 700;">-${Math.round(fiscal)}</span>` : '<span style="color: #94a3b8;">0</span>'}</td>`;
                }).join('')}
              </tr>
              <tr style="border-bottom: 1px solid #e2e8f0;">
                <td style="padding: 0.75rem; color: #475569; font-size: 1rem;">üö® Penalizaci√≥n por Omisi√≥n</td>
                ${candidateData.map(({ score }) => {
                  const omission = getOmissionPenalty(score);
                  return `<td style="text-align: center; padding: 0.75rem; font-size: 1rem;">${omission > 0 ? `<span style="color: #dc2626; font-weight: 700;">-${Math.round(omission)}</span>` : '<span style="color: #94a3b8;">0</span>'}</td>`;
                }).join('')}
              </tr>
              <tr style="border-bottom: 1px solid #e2e8f0;">
                <td style="padding: 0.75rem; color: #475569; font-size: 1rem;">‚öñÔ∏è Penalizaci√≥n por Viabilidad</td>
                ${candidateData.map(({ score }) => {
                  const viability = getViabilityPenalty(score);
                  return `<td style="text-align: center; padding: 0.75rem; font-size: 1rem;">${viability > 0 ? `<span style="color: #dc2626; font-weight: 700;">-${Math.round(viability)}</span>` : '<span style="color: #94a3b8;">0</span>'}</td>`;
                }).join('')}
              </tr>
              <tr style="background: #f8fafc; font-weight: 700;">
                <td style="padding: 0.75rem; color: #1e3a5f; font-size: 1.125rem;">Total Penalizaciones</td>
                ${candidateData.map(({ score }) => {
                  const total = getTotalPenalties(score);
                  return `<td style="text-align: center; padding: 0.75rem; color: #dc2626; font-size: 1.125rem;">${total > 0 ? `-${Math.round(total)}` : '0'}</td>`;
                }).join('')}
              </tr>
            </tbody>
          </table>
        </div>
      `;
    }
    
    // Render Bonuses Comparison
    if (readingBonuses) {
      readingBonuses.innerHTML = `
        <div style="overflow-x: auto;">
          <table style="width: 100%; font-size: 1rem; border-collapse: collapse;">
            <thead>
              <tr style="border-bottom: 2px solid #1e3a5f;">
                <th style="text-align: left; padding: 0.75rem; font-weight: 700; color: #1e3a5f; font-size: 1.125rem;">Tipo de Bono</th>
                ${candidateData.map(({ candidate }) => `
                  <th style="text-align: center; padding: 0.75rem; font-weight: 700; color: #1e3a5f; font-size: 1.125rem;">${getCandidateName(candidate)}</th>
                `).join('')}
              </tr>
            </thead>
            <tbody>
              <tr style="border-bottom: 1px solid #e2e8f0;">
                <td style="padding: 0.75rem; color: #475569; font-size: 1rem;">üéØ M√∫ltiples Propuestas (3+)</td>
                ${candidateData.map(({ score }) => {
                  const bonuses = getBonusesByType(score);
                  return `<td style="text-align: center; padding: 0.75rem; font-size: 1rem;">${bonuses.multiple > 0 ? `<span style="color: #059669; font-weight: 700;">+${bonuses.multiple.toFixed(1)}</span>` : '<span style="color: #94a3b8;">0</span>'}</td>`;
                }).join('')}
              </tr>
              <tr style="border-bottom: 1px solid #e2e8f0;">
                <td style="padding: 0.75rem; color: #475569; font-size: 1rem;">‚≠ê Calidad (Propuestas Completas 4/4)</td>
                ${candidateData.map(({ score }) => {
                  const bonuses = getBonusesByType(score);
                  return `<td style="text-align: center; padding: 0.75rem; font-size: 1rem;">${bonuses.quality > 0 ? `<span style="color: #059669; font-weight: 700;">+${bonuses.quality.toFixed(1)}</span>` : '<span style="color: #94a3b8;">0</span>'}</td>`;
                }).join('')}
              </tr>
              <tr style="border-bottom: 1px solid #e2e8f0;">
                <td style="padding: 0.75rem; color: #475569; font-size: 1rem;">üí∞ Financiamiento</td>
                ${candidateData.map(({ score }) => {
                  const bonuses = getBonusesByType(score);
                  return `<td style="text-align: center; padding: 0.75rem; font-size: 1rem;">${bonuses.funding > 0 ? `<span style="color: #059669; font-weight: 700;">+${bonuses.funding.toFixed(1)}</span>` : '<span style="color: #94a3b8;">0</span>'}</td>`;
                }).join('')}
              </tr>
              <tr style="background: #f8fafc; font-weight: 700;">
                <td style="padding: 0.75rem; color: #1e3a5f; font-size: 1.125rem;">Total Bonos</td>
                ${candidateData.map(({ score }) => {
                  const total = getTotalBonuses(score);
                  return `<td style="text-align: center; padding: 0.75rem; color: #059669; font-size: 1.125rem;">${total > 0 ? `+${total.toFixed(1)}` : '0'}</td>`;
                }).join('')}
              </tr>
            </tbody>
          </table>
        </div>
      `;
    }
    
    // Render Flags Comparison
    if (readingFlags) {
      const allFlagsMap = new Map();
      candidateData.forEach(({ score }) => {
        getActiveFlags(score).forEach(flag => {
          if (!allFlagsMap.has(flag.key)) {
            allFlagsMap.set(flag.key, { label: flag.label, category: flag.category });
          }
        });
      });
      
      if (allFlagsMap.size > 0) {
        const flagsByCategory = {};
        allFlagsMap.forEach((flag, key) => {
          if (!flagsByCategory[flag.category]) {
            flagsByCategory[flag.category] = [];
          }
          flagsByCategory[flag.category].push({ key, ...flag });
        });
        
        readingFlags.innerHTML = `
          <div style="display: flex; flex-direction: column; gap: 1.5rem;">
            ${Object.entries(flagsByCategory).map(([category, flags]) => `
              <div>
                <h4 style="font-weight: 700; color: #1e3a5f; margin-bottom: 0.75rem; font-size: 1.125rem;">${category}</h4>
                <div style="overflow-x: auto;">
                  <table style="width: 100%; font-size: 1rem; border-collapse: collapse;">
                    <thead>
                      <tr style="border-bottom: 2px solid #1e3a5f;">
                        <th style="text-align: left; padding: 0.75rem; font-weight: 700; color: #1e3a5f; font-size: 1.125rem;">Flag</th>
                        ${candidateData.map(({ candidate }) => `
                          <th style="text-align: center; padding: 0.75rem; font-weight: 700; color: #1e3a5f; font-size: 1.125rem;">${getCandidateName(candidate)}</th>
                        `).join('')}
                      </tr>
                    </thead>
                    <tbody>
                      ${flags.map(flag => `
                        <tr style="border-bottom: 1px solid #e2e8f0;">
                          <td style="padding: 0.75rem; color: #475569; font-size: 1rem;">${flag.label}</td>
                          ${candidateData.map(({ score }) => {
                            const candidateFlags = getActiveFlags(score);
                            const hasFlag = candidateFlags.some(f => f.key === flag.key);
                            return `<td style="text-align: center; padding: 0.75rem; font-size: 1.125rem;">${hasFlag ? '<span style="color: #2563eb; font-weight: 700;">‚úì</span>' : '<span style="color: #cbd5e1;">‚Äî</span>'}</td>`;
                          }).join('')}
                        </tr>
                      `).join('')}
                    </tbody>
                  </table>
                </div>
              </div>
            `).join('')}
          </div>
        `;
      } else {
        readingFlags.innerHTML = '<p style="color: #64748b; font-size: 1rem;">Ninguno de los candidatos seleccionados tiene informaci√≥n adicional activa.</p>';
      }
    }
    
    // Render Urgency Coverage Comparison
    if (readingUrgency) {
      readingUrgency.innerHTML = `
        <div style="overflow-x: auto;">
          <table style="width: 100%; font-size: 1rem; border-collapse: collapse;">
            <thead>
              <tr style="border-bottom: 2px solid #1e3a5f;">
                <th style="text-align: left; padding: 0.75rem; font-weight: 700; color: #1e3a5f; font-size: 1.125rem;">Urgencia Nacional</th>
                ${candidateData.map(({ candidate }) => `
                  <th style="text-align: center; padding: 0.75rem; font-weight: 700; color: #1e3a5f; font-size: 1.125rem;">${getCandidateName(candidate)}</th>
                `).join('')}
              </tr>
            </thead>
            <tbody>
              <tr style="border-bottom: 1px solid #e2e8f0;">
                <td style="padding: 0.75rem; color: #475569; font-size: 1rem;">üõ°Ô∏è Operaciones de Seguridad</td>
                ${candidateData.map(({ score }) => {
                  const coverage = getUrgencyCoverage(score);
                  return `<td style="text-align: center; padding: 0.75rem; font-size: 1rem;">${coverage.security ? '<span style="color: #059669; font-weight: 700;">‚úì Cubre</span>' : '<span style="color: #dc2626; font-weight: 700;">‚úó No cubre</span>'}</td>`;
                }).join('')}
              </tr>
              <tr style="border-bottom: 1px solid #e2e8f0;">
                <td style="padding: 0.75rem; color: #475569; font-size: 1rem;">üè• Crisis CCSS</td>
                ${candidateData.map(({ score }) => {
                  const coverage = getUrgencyCoverage(score);
                  return `<td style="text-align: center; padding: 0.75rem; font-size: 1rem;">${coverage.ccss ? '<span style="color: #059669; font-weight: 700;">‚úì Cubre</span>' : '<span style="color: #dc2626; font-weight: 700;">‚úó No cubre</span>'}</td>`;
                }).join('')}
              </tr>
              <tr style="border-bottom: 1px solid #e2e8f0;">
                <td style="padding: 0.75rem; color: #475569; font-size: 1rem;">üíº Empleo Formal</td>
                ${candidateData.map(({ score }) => {
                  const coverage = getUrgencyCoverage(score);
                  return `<td style="text-align: center; padding: 0.75rem; font-size: 1rem;">${coverage.employment ? '<span style="color: #059669; font-weight: 700;">‚úì Cubre</span>' : '<span style="color: #dc2626; font-weight: 700;">‚úó No cubre</span>'}</td>`;
                }).join('')}
              </tr>
              <tr style="border-bottom: 1px solid #e2e8f0;">
                <td style="padding: 0.75rem; color: #475569; font-size: 1rem;">üö® Crimen Organizado</td>
                ${candidateData.map(({ score }) => {
                  const coverage = getUrgencyCoverage(score);
                  return `<td style="text-align: center; padding: 0.75rem; font-size: 1rem;">${coverage.crime ? '<span style="color: #059669; font-weight: 700;">‚úì Cubre</span>' : '<span style="color: #dc2626; font-weight: 700;">‚úó No cubre</span>'}</td>`;
                }).join('')}
              </tr>
            </tbody>
          </table>
        </div>
      `;
    }
  }
</script>
