---
import BaseLayout from '../layouts/BaseLayout.astro';
import PillarGrid from '../components/pillars/PillarGrid.astro';
import ExpressSwiper from '../components/modes/express/ExpressSwiper.astro';
import ReadingRanking from '../components/modes/reading/ReadingRanking.astro';
import { candidates, getRankingWithCandidates, scoresByCandidate, getFiscalStats, analysisByCandidate } from '../lib/data';
import { PILLAR_ICONS } from '../lib/types';

// Import Aceternity components
import { HeroSection } from '../components/ui/aceternity/HeroSection';
import { StatsCards } from '../components/ui/aceternity/StatsCards';
import { FiscalRiskDashboard } from '../components/ui/aceternity/FiscalRiskDashboard';
import { RankingTable } from '../components/ui/aceternity/RankingTable';
import { HoverEffect } from '../components/ui/aceternity/HoverEffect';
import { BentoGrid, BentoGridItem } from '../components/ui/aceternity/BentoGrid';
import { MovingBorder } from '../components/ui/aceternity/MovingBorder';
import { TabsController } from '../components/ui/aceternity/TabsController';

// Define tabs for the main content sections
const mainTabs = [
  { id: "como-evaluamos", label: "¬øC√≥mo evaluamos?", icon: "üîç" }, 
  { id: "top-candidatos", label: "Top 10 Candidatos", icon: "üèÜ" },
  { id: "pilares", label: "10 Pilares de Evaluaci√≥n", icon: "üèõÔ∏è" },
];

// Funci√≥n para obtener prioridad de riesgo (mismo que en ranking.astro)
function getRiskPriority(riskLevel: string): number {
  if (riskLevel === 'BAJO') return 0;
  if (riskLevel === 'MEDIO') return 1;
  return 2;
}

// Obtener ranking ordenado igual que en ranking.astro (por riesgo primero, luego por weighted_sum)
const rawRanking = getRankingWithCandidates();
const sortedRanking = [...rawRanking].sort((a, b) => {
  const riskA = getRiskPriority(a.analysis?.risk_level || 'BAJO');
  const riskB = getRiskPriority(b.analysis?.risk_level || 'BAJO');
  if (riskA !== riskB) return riskA - riskB;
  return (b.weighted_sum || 0) - (a.weighted_sum || 0);
});

// Prepare ranking data for all modes
const rankingData = sortedRanking.map((entry, index) => ({
  candidate: entry.candidate,
  score: scoresByCandidate[entry.candidate_id],
  analysis: analysisByCandidate[entry.candidate_id],
  rank: index + 1,
}));

const fiscalStats = getFiscalStats();

// Prepare data for Aceternity components (Top 10 del ranking ordenado)
const rankingEntries = sortedRanking.slice(0, 10).map((entry, idx) => {
  const candidateName = entry.candidate?.candidate_name;
  const hasValidName = candidateName && candidateName !== 'Por determinar' && candidateName !== 'no_especificado';
  // total_penalties viene del ranking.json y es negativo (ej: -3, -2, 0)
  // Mantenemos el valor negativo para que el componente RankingTable lo muestre correctamente
  const totalPenalty = (entry as any).total_penalties || 0;
  
  return {
    id: entry.candidate_id,
    name: hasValidName ? candidateName : entry.candidate?.party_name || entry.candidate_id.toUpperCase(),
    party: entry.candidate?.party_name || entry.candidate_id.toUpperCase(),
    score: Math.round((entry.weighted_sum || 0) * 100),
    rank: idx + 1,
    riskLevel: (entry.analysis?.risk_level || 'BAJO') as "BAJO" | "MEDIO" | "ALTO",
    penalty: totalPenalty,
  };
});

const statsData = [
  { value: candidates.length, label: "Candidatos", gradient: "from-cyan-600 to-blue-600" },
  { value: 10, label: "Pilares", gradient: "from-blue-600 to-indigo-600" },
  { value: 11, label: "Tipos de penalizaci√≥n", gradient: "from-indigo-600 to-purple-600" },
  { value: 4, label: "Dimensiones", gradient: "from-purple-600 to-pink-600" },
];

const howItWorksItems = [
  {
    title: "Existencia",
    description: "¬øEs una propuesta concreta y clara?",
    link: "/metodologia#existencia",
    icon: "üìã",
    badge: "Dimensi√≥n 1",
    badgeColor: "bg-white/80 text-emerald-700",
    bgColor: "from-emerald-50 to-teal-50 border-emerald-200",
    iconBg: "from-emerald-500 to-teal-600",
  },
  {
    title: "Cu√°ndo",
    description: "¬øTiene un plazo definido para implementarse?",
    link: "/metodologia#cuando",
    icon: "üìÖ",
    badge: "Dimensi√≥n 2",
    badgeColor: "bg-white/80 text-blue-700",
    bgColor: "from-blue-50 to-sky-50 border-blue-200",
    iconBg: "from-blue-500 to-sky-600",
  },
  {
    title: "C√≥mo",
    description: "¬øExplica el mecanismo de implementaci√≥n?",
    link: "/metodologia#como",
    icon: "‚öôÔ∏è",
    badge: "Dimensi√≥n 3",
    badgeColor: "bg-white/80 text-purple-700",
    bgColor: "from-purple-50 to-violet-50 border-purple-200",
    iconBg: "from-purple-500 to-violet-600",
  },
  {
    title: "Fondos",
    description: "¬øIndica fuentes de financiamiento claras?",
    link: "/metodologia#fondos",
    icon: "üí∞",
    badge: "Dimensi√≥n 4",
    bgColor: "from-amber-50 to-yellow-50 border-amber-200",
    iconBg: "from-amber-500 to-yellow-600",
    badgeColor: "bg-white/80 text-amber-700",
  },
  {
    title: "Penalizaciones",
    description: "¬øAfecta negativamente las finanzas p√∫blicas o viola principios constitucionales?",
    bgColor: "from-rose-50 to-red-50 border-rose-200",
    iconBg: "from-rose-500 to-red-600",
    link: "/metodologia#penalizaciones",
    icon: "‚ö†Ô∏è",
    badge: "Fiscal + Legal",
    badgeColor: "bg-white/80 text-rose-700",
  },
];
---

<BaseLayout 
  title="Inicio"
  description="Compara los planes de gobierno de los 20 candidatos presidenciales de Costa Rica 2026-2030. An√°lisis neutral, verificable y sin sesgos ideol√≥gicos. Rankings, comparador y an√°lisis detallado de propuestas."
>
  
  <!-- ============================================
       EXPRESS MODE üöÄ
       ============================================ -->
  <div class="mode-express-content">
    <ExpressSwiper candidates={rankingData} fiscalStats={fiscalStats} />
  </div>

  <!-- ============================================
       DASHBOARD MODE üìä (Default) - ACETERNITY UI
       ============================================ -->
  <div class="mode-dashboard-content">
      
    <!-- Hero Section -->
    <HeroSection
      client:load
      title="Costa Rica"
      highlight="Decide 2026"
      subtitle={`Compara los planes de gobierno de los {count} candidatos presidenciales.`}
      candidateCount={candidates.length}
      primaryAction={{ label: "Ver rankings", href: "/ranking" }}
      secondaryAction={{ label: "¬øC√≥mo funciona?", href: "/metodologia" }}
    />

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 pb-16 space-y-16">

      <!-- Stats Section -->
      <section>
        <div class="flex items-center gap-3 mb-6">
          <span class="w-10 h-10 rounded-xl bg-gradient-to-br from-cyan-500 to-blue-600 flex items-center justify-center text-white text-lg shadow-lg">
            üìä
          </span>
          <h2 class="text-2xl font-bold text-slate-900">En n√∫meros</h2>
              </div>
        <StatsCards client:visible stats={statsData} />
      </section>

      <!-- Tabs Section -->
      <section>
        <div class="mb-6">
          <TabsController 
            client:load 
            tabs={mainTabs} 
            defaultTab="como-evaluamos"
            containerId="main-tabs-content"
          />
            </div>

        <div id="main-tabs-content" data-active-tab="como-evaluamos">
          <!-- Tab: How It Works -->
          <div class="tab-panel" data-tab="como-evaluamos">
            <div class="flex items-center gap-3 mb-6">
              <span class="w-10 h-10 rounded-xl bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center text-white text-lg shadow-lg">
                üîç
              </span>
              <h2 class="text-2xl font-bold text-slate-900">¬øC√≥mo evaluamos?</h2>
            </div>
            <HoverEffect client:visible items={howItWorksItems} />
          </div>

          <!-- Tab: Ranking Section -->
          <div class="tab-panel" data-tab="top-candidatos">
            <div class="flex items-center gap-3 mb-6">
              <span class="w-10 h-10 rounded-xl bg-gradient-to-br from-blue-500 to-cyan-600 flex items-center justify-center text-white text-lg shadow-lg">
                üèÜ
              </span>
              <h2 class="text-2xl font-bold text-slate-900">Top 10 Candidatos</h2>
            </div>
            <RankingTable 
              client:visible 
              entries={rankingEntries} 
              limit={10}
              showViewAll={true}
            />
        </div>
        
          <!-- Tab: Pillars Section -->
          <div class="tab-panel" data-tab="pilares">
            <div class="flex items-center gap-3 mb-4">
              <span class="w-10 h-10 rounded-xl bg-gradient-to-br from-emerald-500 to-teal-600 flex items-center justify-center text-white text-lg shadow-lg">
                üèõÔ∏è
              </span>
              <h2 class="text-2xl font-bold text-slate-900">10 Pilares de Evaluaci√≥n</h2>
            </div>
            
            <!-- Leyenda explicativa -->
            <div class="mb-6 p-4 bg-gradient-to-r from-slate-50 to-slate-100 rounded-xl border border-slate-200">
              <p class="text-sm text-slate-600 mb-3">
                <strong class="text-slate-800">¬øC√≥mo interpretar cada pilar?</strong>
              </p>
              <div class="grid grid-cols-1 sm:grid-cols-3 gap-3 text-sm">
            <div class="flex items-center gap-2">
                  <span class="w-8 h-8 rounded-lg bg-gradient-to-br from-cyan-500 to-blue-600 flex items-center justify-center text-white text-xs font-bold shadow">%</span>
                  <span class="text-slate-600"><strong class="text-slate-800">Porcentaje grande:</strong> Promedio de todos los candidatos</span>
            </div>
                <div class="flex items-center gap-2">
                  <span class="px-2 py-1 rounded-full bg-slate-200 text-slate-600 text-xs font-semibold">10%</span>
                  <span class="text-slate-600"><strong class="text-slate-800">Badge superior:</strong> Peso/importancia del pilar</span>
                </div>
            <div class="flex items-center gap-2">
                  <span class="w-5 h-5 rounded-full bg-amber-400 flex items-center justify-center text-white text-xs font-bold">1</span>
                  <span class="text-slate-600"><strong class="text-slate-800">Top 5:</strong> Mejores candidatos en ese pilar</span>
                </div>
              </div>
            </div>
            
            <PillarGrid />
          </div>
        </div>
      </section>

      <!-- Fiscal Risk Dashboard (after "¬øC√≥mo evaluamos?") -->
      <section class="mt-8">
        <div class="flex items-center gap-3 mb-4">
          <span class="w-10 h-10 rounded-xl bg-gradient-to-br from-amber-500 to-red-500 flex items-center justify-center text-white text-lg shadow-lg">
            ‚ö†Ô∏è
          </span>
          <h2 class="text-2xl font-bold text-slate-900">Riesgo y Responsabilidad de los Planes</h2>
        </div>

        <!-- Contexto educativo y neutral mejorado -->
        <div class="mb-6 p-5 bg-gradient-to-br from-slate-50 to-blue-50 border border-slate-200 rounded-xl">
          <p class="text-slate-700 leading-relaxed mb-4">
            El <strong>motor de an√°lisis</strong> eval√∫a si los planes de gobierno <strong>comprometen la estabilidad financiera</strong> del pa√≠s, 
            <strong>omiten urgencias nacionales</strong> que deben abordarse, o <strong>violan principios constitucionales</strong>. 
            Esta informaci√≥n le ayuda a entender qu√© tan completas, responsables y viables son las propuestas.
          </p>
          
          <!-- Tres tipos de penalizaciones -->
          <div class="grid md:grid-cols-3 gap-3 mb-4">
            <div class="flex items-start gap-2 p-3 bg-red-50 border border-red-200 rounded-lg">
              <span class="text-red-600 mt-0.5 text-lg">üî¥</span>
              <div class="text-sm">
                <strong class="text-slate-800 block mb-1">Penalizaciones Fiscales</strong>
                <span class="text-slate-600">Atacan la regla fiscal o proponen m√°s deuda sin plan de sostenibilidad</span>
              </div>
            </div>
            <div class="flex items-start gap-2 p-3 bg-amber-50 border border-amber-200 rounded-lg">
              <span class="text-amber-600 mt-0.5 text-lg">üü†</span>
              <div class="text-sm">
                <strong class="text-slate-800 block mb-1">Omisiones de Urgencias</strong>
                <span class="text-slate-600">Ignoran temas cr√≠ticos como seguridad operativa o crisis de la CCSS</span>
              </div>
            </div>
            <div class="flex items-start gap-2 p-3 bg-blue-50 border border-blue-200 rounded-lg">
              <span class="text-blue-600 mt-0.5 text-lg">‚öñÔ∏è</span>
              <div class="text-sm">
                <strong class="text-slate-800 block mb-1">Viabilidad Legal</strong>
                <span class="text-slate-600">Violan separaci√≥n de poderes, derechos fundamentales o garant√≠as constitucionales</span>
              </div>
            </div>
          </div>

          <!-- Bonos y Flags -->
          <div class="grid md:grid-cols-2 gap-3 mb-4 pt-4 border-t border-slate-200">
            <div class="flex items-start gap-2 p-3 bg-emerald-50 border border-emerald-200 rounded-lg">
              <span class="text-emerald-600 mt-0.5 text-lg">üéÅ</span>
              <div class="text-sm">
                <strong class="text-slate-800 block mb-1">Sistema de Bonos</strong>
                <span class="text-slate-600">Premiamos m√∫ltiples propuestas (3+), propuestas completas (4/4 dimensiones) y propuestas con financiamiento claro</span>
              </div>
            </div>
            <div class="flex items-start gap-2 p-3 bg-indigo-50 border border-indigo-200 rounded-lg">
              <span class="text-indigo-600 mt-0.5 text-lg">‚ÑπÔ∏è</span>
              <div class="text-sm">
                <strong class="text-slate-800 block mb-1">Flags Informativos</strong>
                <span class="text-slate-600">Informaci√≥n objetiva basada en evidencia verificable. <strong>NO penalizan</strong> el score</span>
              </div>
            </div>
          </div>

          <p class="text-xs text-slate-500 mt-3 pt-3 border-t border-slate-200">
            Esta evaluaci√≥n se basa en el <strong>texto literal</strong> de los planes de gobierno. No juzga ideolog√≠as ni predice resultados. 
            <a href="/metodologia#penalizaciones" class="text-cyan-600 hover:text-cyan-700 underline font-medium">Ver metodolog√≠a completa ‚Üí</a>
          </p>
        </div>
        
        <FiscalRiskDashboard client:visible stats={fiscalStats} />
      </section>


      <!-- CTA Section -->
      <section class="relative overflow-hidden rounded-3xl bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 p-8 md:p-12">
        <!-- Background decorations -->
        <div class="absolute inset-0 opacity-30">
          <div class="absolute top-0 right-0 w-64 h-64 bg-cyan-500 rounded-full blur-3xl translate-x-1/2 -translate-y-1/2"></div>
          <div class="absolute bottom-0 left-0 w-64 h-64 bg-blue-500 rounded-full blur-3xl -translate-x-1/2 translate-y-1/2"></div>
        </div>
        
        <div class="relative z-10 text-center">
          <h2 class="text-3xl md:text-4xl font-bold text-white mb-4">
            ¬øListo para comparar?
          </h2>
          <p class="text-lg text-slate-300 max-w-2xl mx-auto mb-8">
            Selecciona hasta 4 candidatos y compara sus propuestas lado a lado.
            Ahora puedes ver el riesgo y responsabilidad de cada plan.
          </p>
          <MovingBorder
            client:load
            as="a"
            href="/comparar"
            className="text-lg px-10 py-5 bg-slate-900"
            duration={4000}
          >
            Ir al comparador
          </MovingBorder>
        </div>
      </section>

    </div>
  </div>

  <!-- ============================================
       READING MODE üìñ
       ============================================ -->
  <div class="mode-reading-content">
    <ReadingRanking candidates={rankingData} currentPage={1} fiscalStats={fiscalStats} />
  </div>

</BaseLayout>

<style>
  /* Mode visibility */
  .mode-express-content,
  .mode-reading-content {
    display: none;
  }
  
  .mode-dashboard-content {
    display: block;
  }
  
  /* Express mode */
  html[data-mode="express"] .mode-express-content {
    display: block;
  }
  
  html[data-mode="express"] .mode-dashboard-content,
  html[data-mode="express"] .mode-reading-content {
    display: none;
  }
  
  /* Reading mode */
  html[data-mode="reading"] .mode-reading-content {
    display: block;
  }
  
  html[data-mode="reading"] .mode-dashboard-content,
  html[data-mode="reading"] .mode-express-content {
    display: none;
  }
  
  /* Tab panels visibility */
  .tab-panel {
    display: none;
    animation: fadeIn 0.3s ease-out;
  }

  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: translateY(10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  /* Show active tab panel */
  #main-tabs-content[data-active-tab="como-evaluamos"] .tab-panel[data-tab="como-evaluamos"],
  #main-tabs-content[data-active-tab="top-candidatos"] .tab-panel[data-tab="top-candidatos"],
  #main-tabs-content[data-active-tab="pilares"] .tab-panel[data-tab="pilares"] {
    display: block;
  }
</style>
