---
import BaseLayout from '../layouts/BaseLayout.astro';
import PillarGrid from '../components/pillars/PillarGrid.astro';
import ExpressSwiper from '../components/modes/express/ExpressSwiper.astro';
import ReadingRanking from '../components/modes/reading/ReadingRanking.astro';
import { candidates, getRankingWithCandidates, scoresByCandidate, getFiscalStats, analysisByCandidate } from '../lib/data';
import { PILLAR_ICONS } from '../lib/types';

// Import Aceternity components
import { HeroSection } from '../components/ui/aceternity/HeroSection';
import { StatsCards } from '../components/ui/aceternity/StatsCards';
import { FiscalRiskDashboard } from '../components/ui/aceternity/FiscalRiskDashboard';
import { RankingTable } from '../components/ui/aceternity/RankingTable';
import { HoverEffect } from '../components/ui/aceternity/HoverEffect';
import { BentoGrid, BentoGridItem } from '../components/ui/aceternity/BentoGrid';
import { MovingBorder } from '../components/ui/aceternity/MovingBorder';

// Prepare ranking data for all modes
const rankingData = getRankingWithCandidates().map((entry, index) => ({
  candidate: entry.candidate,
  score: scoresByCandidate[entry.candidate_id],
  analysis: analysisByCandidate[entry.candidate_id],
  rank: index + 1,
}));

const fiscalStats = getFiscalStats();

// Prepare data for Aceternity components
const rankingEntries = getRankingWithCandidates().slice(0, 10).map((entry, idx) => {
  const candidateName = entry.candidate?.candidate_name;
  const hasValidName = candidateName && candidateName !== 'Por determinar' && candidateName !== 'no_especificado';
  
  return {
    id: entry.candidate_id,
    name: hasValidName ? candidateName : entry.candidate?.party_name || entry.candidate_id.toUpperCase(),
    party: entry.candidate?.party_name || entry.candidate_id.toUpperCase(),
    score: Math.round((entry.weighted_sum || 0) * 100),
    rank: idx + 1,
    riskLevel: (entry.analysis?.risk_level || 'BAJO') as "BAJO" | "MEDIO" | "ALTO",
    penalty: (entry as any).total_penalties || 0,
  };
});

const statsData = [
  { value: candidates.length, label: "Candidatos", gradient: "from-cyan-600 to-blue-600" },
  { value: 10, label: "Pilares", gradient: "from-blue-600 to-indigo-600" },
  { value: 6, label: "Tipos de penalizaciÃ³n", gradient: "from-indigo-600 to-purple-600" },
  { value: 4, label: "Dimensiones", gradient: "from-purple-600 to-pink-600" },
];

const howItWorksItems = [
  {
    title: "Existencia",
    description: "Â¿Es una propuesta concreta y clara?",
    link: "/metodologia#existencia",
    icon: "ğŸ“‹",
    badge: "DimensiÃ³n 1",
    badgeColor: "bg-white/80 text-emerald-700",
    bgColor: "from-emerald-50 to-teal-50 border-emerald-200",
    iconBg: "from-emerald-500 to-teal-600",
  },
  {
    title: "CuÃ¡ndo",
    description: "Â¿Tiene un plazo definido para implementarse?",
    link: "/metodologia#cuando",
    icon: "ğŸ“…",
    badge: "DimensiÃ³n 2",
    badgeColor: "bg-white/80 text-blue-700",
    bgColor: "from-blue-50 to-sky-50 border-blue-200",
    iconBg: "from-blue-500 to-sky-600",
  },
  {
    title: "CÃ³mo",
    description: "Â¿Explica el mecanismo de implementaciÃ³n?",
    link: "/metodologia#como",
    icon: "âš™ï¸",
    badge: "DimensiÃ³n 3",
    badgeColor: "bg-white/80 text-purple-700",
    bgColor: "from-purple-50 to-violet-50 border-purple-200",
    iconBg: "from-purple-500 to-violet-600",
  },
  {
    title: "Fondos",
    description: "Â¿Indica fuentes de financiamiento claras?",
    link: "/metodologia#fondos",
    icon: "ğŸ’°",
    badge: "DimensiÃ³n 4",
    bgColor: "from-amber-50 to-yellow-50 border-amber-200",
    iconBg: "from-amber-500 to-yellow-600",
    badgeColor: "bg-white/80 text-amber-700",
  },
  {
    title: "Penalizaciones",
    description: "Â¿Afecta negativamente las finanzas pÃºblicas?",
    bgColor: "from-rose-50 to-red-50 border-rose-200",
    iconBg: "from-rose-500 to-red-600",
    link: "/metodologia#penalizaciones",
    icon: "âš ï¸",
    badge: "Fiscal",
    badgeColor: "bg-white/80 text-rose-700",
  },
];
---

<BaseLayout title="Inicio">
  
  <!-- ============================================
       EXPRESS MODE ğŸš€
       ============================================ -->
  <div class="mode-express-content">
    <ExpressSwiper candidates={rankingData} />
  </div>

  <!-- ============================================
       DASHBOARD MODE ğŸ“Š (Default) - ACETERNITY UI
       ============================================ -->
  <div class="mode-dashboard-content">
    
    <!-- Hero Section -->
    <HeroSection
      client:load
      title="Costa Rica"
      highlight="Decide 2026"
      subtitle={`Compara los planes de gobierno de los {count} candidatos presidenciales.`}
      candidateCount={candidates.length}
      primaryAction={{ label: "Ver rankings", href: "/ranking" }}
      secondaryAction={{ label: "Â¿CÃ³mo funciona?", href: "/metodologia" }}
    />

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 pb-16 space-y-16">

      <!-- Fiscal Risk Dashboard -->
      <section>
        <div class="flex items-center gap-3 mb-6">
          <span class="w-10 h-10 rounded-xl bg-gradient-to-br from-amber-500 to-red-500 flex items-center justify-center text-white text-lg shadow-lg">
            âš ï¸
          </span>
          <h2 class="text-2xl font-bold text-slate-900">Riesgo Fiscal de los Planes</h2>
        </div>
        <FiscalRiskDashboard client:visible stats={fiscalStats} />
      </section>

      <!-- Stats Section -->
      <section>
        <div class="flex items-center gap-3 mb-6">
          <span class="w-10 h-10 rounded-xl bg-gradient-to-br from-cyan-500 to-blue-600 flex items-center justify-center text-white text-lg shadow-lg">
            ğŸ“Š
          </span>
          <h2 class="text-2xl font-bold text-slate-900">En nÃºmeros</h2>
        </div>
        <StatsCards client:visible stats={statsData} />
      </section>

      <!-- How It Works -->
      <section>
        <div class="flex items-center gap-3 mb-6">
          <span class="w-10 h-10 rounded-xl bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center text-white text-lg shadow-lg">
            ğŸ”
          </span>
          <h2 class="text-2xl font-bold text-slate-900">Â¿CÃ³mo evaluamos?</h2>
        </div>
        <HoverEffect client:visible items={howItWorksItems} />
      </section>

      <!-- Pillars Section -->
      <section>
        <div class="flex items-center gap-3 mb-6">
          <span class="w-10 h-10 rounded-xl bg-gradient-to-br from-emerald-500 to-teal-600 flex items-center justify-center text-white text-lg shadow-lg">
            ğŸ›ï¸
          </span>
          <h2 class="text-2xl font-bold text-slate-900">10 Pilares de EvaluaciÃ³n</h2>
        </div>
        <PillarGrid />
      </section>

      <!-- Ranking Section -->
      <section>
        <div class="flex items-center gap-3 mb-6">
          <span class="w-10 h-10 rounded-xl bg-gradient-to-br from-blue-500 to-cyan-600 flex items-center justify-center text-white text-lg shadow-lg">
            ğŸ†
          </span>
          <h2 class="text-2xl font-bold text-slate-900">Top 10 Candidatos</h2>
        </div>
        <RankingTable 
          client:visible 
          entries={rankingEntries} 
          limit={10}
          showViewAll={true}
        />
      </section>

      <!-- CTA Section -->
      <section class="relative overflow-hidden rounded-3xl bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 p-8 md:p-12">
        <!-- Background decorations -->
        <div class="absolute inset-0 opacity-30">
          <div class="absolute top-0 right-0 w-64 h-64 bg-cyan-500 rounded-full blur-3xl translate-x-1/2 -translate-y-1/2"></div>
          <div class="absolute bottom-0 left-0 w-64 h-64 bg-blue-500 rounded-full blur-3xl -translate-x-1/2 translate-y-1/2"></div>
        </div>
        
        <div class="relative z-10 text-center">
          <h2 class="text-3xl md:text-4xl font-bold text-white mb-4">
            Â¿Listo para comparar?
          </h2>
          <p class="text-lg text-slate-300 max-w-2xl mx-auto mb-8">
            Selecciona hasta 4 candidatos y compara sus propuestas lado a lado.
            Ahora puedes ver el riesgo fiscal de cada plan.
          </p>
          <MovingBorder
            client:load
            as="a"
            href="/comparar"
            className="text-lg px-10 py-5 bg-slate-900"
            duration={4000}
          >
            Ir al comparador
          </MovingBorder>
        </div>
      </section>

    </div>
  </div>

  <!-- ============================================
       READING MODE ğŸ“–
       ============================================ -->
  <div class="mode-reading-content">
    <ReadingRanking candidates={rankingData} currentPage={1} />
  </div>

</BaseLayout>

<style>
  /* Mode visibility */
  .mode-express-content,
  .mode-reading-content {
    display: none;
  }
  
  .mode-dashboard-content {
    display: block;
  }
  
  /* Express mode */
  html[data-mode="express"] .mode-express-content {
    display: block;
  }
  
  html[data-mode="express"] .mode-dashboard-content,
  html[data-mode="express"] .mode-reading-content {
    display: none;
  }
  
  /* Reading mode */
  html[data-mode="reading"] .mode-reading-content {
    display: block;
  }
  
  html[data-mode="reading"] .mode-dashboard-content,
  html[data-mode="reading"] .mode-express-content {
    display: none;
  }
</style>
